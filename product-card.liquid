{% assign p = product %}
{% assign is_sample = false %}
{% if product.tags contains 'sample' %}
  {% assign is_sample = true %}
{% endif %}

{% if p == blank %}
  <div class="pfc-section page-width" style="padding: 20px; text-align: center;">
    <p>No product context available.</p>
  </div>
{% else %}
  {% liquid
    if p != blank
      assign current_variant = p.selected_or_first_available_variant
    else
      assign current_variant = blank
    endif

    assign category_type = product.metafields.custom.category_type | default: '' | downcase

    # Централна логика по category_type
    # За laminate: по подразбиране show_calculator_flag = true
    # За други категории: по подразбиране show_calculator_flag = false
    if category_type == 'laminate'
      assign show_calculator_flag = true
    else
      assign show_calculator_flag = false
    endif

    # Manual override чрез метафилд show_calculator
    if product.metafields.custom.show_calculator != nil
      assign show_calculator_flag = product.metafields.custom.show_calculator
    endif

    # Sample банер логика: проверката се прави директно в HTML блока, не тук

    # Promotional Add-on логика
    assign show_promotional_addon_flag = false
    if product.metafields.custom.show_promo == true
      assign show_promotional_addon_flag = true
    elsif category_type == 'laminate'
      # За laminate може да е true по подразбиране, но се override-ва от метафилда
      assign show_promotional_addon_flag = true
      if product.metafields.custom.show_promo == false
        assign show_promotional_addon_flag = false
      endif
    endif

    # Product Category блок логика
    assign show_category_block_flag = false
    if product.metafields.custom.show_addon_category == true
      assign show_category_block_flag = true
    elsif category_type == 'laminate'
      # За laminate може да е true по подразбиране, но се override-ва от метафилда
      assign show_category_block_flag = true
      if product.metafields.custom.show_addon_category == false
        assign show_category_block_flag = false
      endif
    endif
  %}

  {% comment %} Sample продукт логика: използваме директно метафилда sample_product {% endcomment %}
  {% assign sample_product = blank %}
  
  {% if product.metafields.custom.sample_product != blank %}
    {% assign sample_product = product.metafields.custom.sample_product.value %}
  {% endif %}
  
  {% comment %} Определяме максималния брой мостри - използваме sample_limit метафилд {% endcomment %}
  {% assign sample_limit = 3 %}
  {% if product.metafields.custom.sample_limit != blank %}
    {% assign sample_limit = product.metafields.custom.sample_limit.value | default: product.metafields.custom.sample_limit | plus: 0 %}
    {% if sample_limit == blank or sample_limit == 0 %}
      {% assign sample_limit = 3 %}
    {% endif %}
  {% endif %}

  {% comment %} Определяме дали калкулаторът ще се показва - използваме show_calculator_flag от логиката в началото {% endcomment %}

  {% comment %} Дефинираме calculator променливи за използване в JavaScript {% endcomment %}
  {% assign calc_package_size = section.settings.package_size | default: 2.196 | plus: 0 %}
  {% if p.metafields.custom.calculator_package_size != blank %}
    {% assign calc_package_size = p.metafields.custom.calculator_package_size.value | default: p.metafields.custom.calculator_package_size | plus: 0 %}
  {% endif %}
  
  {% assign calc_waste_percent = section.settings.waste_percent | default: 5 %}
  {% if p.metafields.custom.calculator_waste_percent != blank %}
    {% assign calc_waste_percent = p.metafields.custom.calculator_waste_percent.value | default: p.metafields.custom.calculator_waste_percent | plus: 0 %}
  {% endif %}
  
  {% assign calc_unit_label = section.settings.unit_label | default: 'm²' %}
  {% if p.metafields.custom.calculator_unit_label != blank %}
    {% assign calc_unit_label = p.metafields.custom.calculator_unit_label.value | default: p.metafields.custom.calculator_unit_label %}
  {% endif %}
  
  {% assign calc_default_quantity = section.settings.default_quantity | default: 10 %}
  {% if p.metafields.custom.calculator_default_quantity != blank %}
    {% assign calc_default_quantity = p.metafields.custom.calculator_default_quantity.value | default: p.metafields.custom.calculator_default_quantity | plus: 0 %}
  {% endif %}
  
  {% assign calc_quantity_step = section.settings.quantity_step | default: 1 %}
  {% if p.metafields.custom.calculator_quantity_step != blank %}
    {% assign calc_quantity_step = p.metafields.custom.calculator_quantity_step.value | default: p.metafields.custom.calculator_quantity_step | plus: 0 %}
  {% endif %}
  
  {% assign calc_min_quantity = section.settings.min_quantity | default: 1 %}
  {% if p.metafields.custom.calculator_min_quantity != blank %}
    {% assign calc_min_quantity = p.metafields.custom.calculator_min_quantity.value | default: p.metafields.custom.calculator_min_quantity | plus: 0 %}
  {% endif %}

  <section class="pfc-section page-width" id="pfc-{{ section.id }}">
  <div class="pfc-grid">
    <div class="pfc-gallery">
      {% render 'pfc-gallery', p: p, section: section %}
      {% render 'pfc-gallery-thumbs', p: p, section: section %}
      {% render 'pfc-gallery-zoom', section: section %}
      {% render 'pfc-gallery-actions', section: section, sample_product: sample_product, show_calculator_flag: show_calculator_flag %}

      {% render 'pfc-accordion', p: p, section: section, product: product %}

      {% assign checklist = product.metafields.custom.checklist_items %}
      {% if checklist != blank %}
        {% assign checklist_items = checklist.value | default: checklist %}
        {% if checklist_items != blank %}
          <div class="product-checklist">
            <ul class="pfc-checklist">
              {% for item in checklist_items %}
                {% if item != blank %}
                  {% assign item_text = item.value | default: item %}
                  {% if item_text != blank %}
                    <li class="pfc-checklist__item checklist-item">
                      <span class="pfc-checklist__icon">✔</span>
                      <span>{{ item_text }}</span>
                    </li>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      {% endif %}

      {% comment %} Метафилдите - преместени от pfc-info в pfc-gallery (под снимката в ляво) {% endcomment %}
      {% render 'pfc-metafields-desktop', p: p, section: section, product: product %}

      {% comment %} Product Category блок се показва според show_category_block_flag {% endcomment %}
      {% if show_category_block_flag %}
      {% assign collection_blocks = section.blocks | where: 'type', 'product_category' %}
      {% if collection_blocks.size > 0 %}
        {% for block in collection_blocks %}
          {% assign show_block = true %}
          {% if block.settings.target_product != blank %}
            {% if p != blank %}
              {% assign target_product_handle = block.settings.target_product %}
              {% assign target_product = all_products[target_product_handle] %}
              {% if target_product != blank %}
                {% unless target_product.handle == p.handle or target_product.id == p.id %}
                  {% assign show_block = false %}
                {% endunless %}
                      {% else %}
                {% assign show_block = false %}
              {% endif %}
                        {% else %}
              {% assign show_block = false %}
                        {% endif %}
                      {% endif %}
          {% if show_block and block.settings.collection != blank %}
            {% assign selected_collection = collections[block.settings.collection] %}
            {% if selected_collection != blank and selected_collection.products.size > 0 %}
              <div class="pfc-collection-slider" {{ block.shopify_attributes }}>
                {% if block.settings.title != blank %}
                  <h3 class="pfc-collection-slider__title">{{ block.settings.title }}</h3>
                {% endif %}
                <div class="pfc-collection-slider__wrapper" data-collection-slider>
                  <button class="pfc-collection-slider__arrow pfc-collection-slider__arrow--prev" type="button" data-collection-prev>‹</button>
                  <div class="pfc-collection-slider__track" data-collection-track>
                    {% assign max_products = block.settings.max_products | default: 6 %}
                    {% for product_item in selected_collection.products limit: max_products %}
                      {% render 'pfc-collection-card', product_item: product_item, current_variant_item: product_item.selected_or_first_available_variant, button_label: block.settings.button_label | default: 'Добави към кошницата' %}
            {% endfor %}
                  </div>
                  <button class="pfc-collection-slider__arrow pfc-collection-slider__arrow--next" type="button" data-collection-next>›</button>
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}
      {% endif %}
    </div>

    <div class="pfc-info">
      {% if section.settings.kicker != blank %}
        <div class="pfc-kicker">{{ section.settings.kicker }}</div>
      {% endif %}

      <h1 class="pfc-title">
        {% if section.settings.custom_title != blank %}
          {{ section.settings.custom_title }}
        {% elsif p != blank %}
          {{ p.title }}
        {% else %}
          Заглавие на продукта
        {% endif %}
      </h1>


      {% comment %} Метафилдите са преместени в pfc-gallery (ляво) - не показваме ги тук {% endcomment %}

      {% assign badge_blocks = section.blocks | where: 'type', 'badge' %}
      {% if badge_blocks.size > 0 %}
        <div class="pfc-badges">
          {% for block in badge_blocks %}
            {% if block.settings.text != blank %}
              <span class="pfc-badge pfc-badge--{{ block.settings.variant }}">
                {{ block.settings.text }}
              </span>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      {% comment %} Показваме цената винаги, когато има продукт и вариант {% endcomment %}
      {% if p != blank %}
        {% if current_variant == blank %}
          {% assign current_variant = p.selected_or_first_available_variant %}
        {% endif %}
        {% if current_variant != blank or section.settings.manual_price != blank %}
          <div class="pfc-price-wrapper">
            {% if current_variant != blank %}
              {% if current_variant.compare_at_price > current_variant.price %}
                <div class="pfc-price-compare" id="pfc-price-compare-{{ section.id }}">
                  {% if current_variant.unit_price != blank %}
                    {% comment %} Primary: Unit price per m² (calculated from compare_at_price) {% endcomment %}
                    {% if section.settings.enable_currency_conversion and section.settings.show_eur_alongside_bgn %}
                      {% assign eur_rate = section.settings.eur_to_bgn_rate | default: "1.95583" | plus: 0.0 %}
                      {% if current_variant.unit_price_measurement != blank and current_variant.unit_price_measurement.quantity_value > 0 %}
                        {% assign compare_unit_price_bgn = current_variant.compare_at_price | divided_by: current_variant.unit_price_measurement.quantity_value | divided_by: 100.0 %}
                      {% else %}
                        {% assign compare_unit_price_bgn = current_variant.compare_at_price | divided_by: 100.0 %}
                      {% endif %}
                      {% assign compare_unit_price_eur = compare_unit_price_bgn | divided_by: eur_rate | round: 2 %}
                      {% assign eur_str = compare_unit_price_eur | append: '' %}
                      {% if eur_str contains '.' %}
                        {% assign eur_parts = eur_str | split: '.' %}
                        {% assign dec = eur_parts[1] %}
                        {% if dec.size == 1 %}{% assign dec = dec | append: '0' %}{% endif %}
                        {% assign eur_str = eur_parts[0] | append: '.' | append: dec %}
                      {% else %}
                        {% assign eur_str = eur_str | append: '.00' %}
                      {% endif %}
                      <span class="pfc-price-eur">{{ eur_str }}€</span>/{{ section.settings.unit_label | default: "m²" }}-{{ compare_unit_price_bgn | round: 2 }} лв/{{ section.settings.unit_label | default: "m²" }}
                    {% else %}
                      {% if current_variant.unit_price_measurement != blank and current_variant.unit_price_measurement.quantity_value > 0 %}
                        {{ current_variant.compare_at_price | divided_by: current_variant.unit_price_measurement.quantity_value | round | money }}/{{ section.settings.unit_label | default: "m²" }}
                      {% else %}
                        {{ current_variant.compare_at_price | money }}/{{ section.settings.unit_label | default: "m²" }}
                      {% endif %}
                    {% endif %}
                  {% comment %} Secondary: Package price {% endcomment %}
                  {% unless section.settings.hide_package_price_top %}
                    <br><small>
                      {% if section.settings.enable_currency_conversion and section.settings.show_eur_alongside_bgn %}
                        {% assign package_price_bgn = current_variant.compare_at_price | divided_by: 100.0 %}
                        {% assign package_price_eur = package_price_bgn | divided_by: eur_rate | round: 2 %}
                        {% assign eur_str = package_price_eur | append: '' %}
                        {% if eur_str contains '.' %}
                          {% assign eur_parts = eur_str | split: '.' %}
                          {% assign dec = eur_parts[1] %}
                          {% if dec.size == 1 %}{% assign dec = dec | append: '0' %}{% endif %}
                          {% assign eur_str = eur_parts[0] | append: '.' | append: dec %}
                        {% else %}
                          {% assign eur_str = eur_str | append: '.00' %}
                        {% endif %}
                        <span class="pfc-price-eur">{{ eur_str }}€</span> / {{ current_variant.compare_at_price | money }}/пакет
                      {% else %}
                        {{ current_variant.compare_at_price | money }}/пакет
                      {% endif %}
                    </small>
                  {% endunless %}
                  {% else %}
                    {% comment %} Fallback if unit_price not available {% endcomment %}
                    {% if section.settings.enable_currency_conversion and section.settings.show_eur_alongside_bgn %}
                      {% assign eur_rate = section.settings.eur_to_bgn_rate | default: "1.95583" | plus: 0.0 %}
                      {% assign compare_price_bgn = current_variant.compare_at_price | divided_by: 100.0 %}
                      {% assign compare_price_eur = compare_price_bgn | divided_by: eur_rate | round: 2 %}
                      {% assign eur_str = compare_price_eur | append: '' %}
                      {% if eur_str contains '.' %}
                        {% assign eur_parts = eur_str | split: '.' %}
                        {% assign dec = eur_parts[1] %}
                        {% if dec.size == 1 %}{% assign dec = dec | append: '0' %}{% endif %}
                        {% assign eur_str = eur_parts[0] | append: '.' | append: dec %}
                      {% else %}
                        {% assign eur_str = eur_str | append: '.00' %}
                      {% endif %}
                      <span class="pfc-price-eur">{{ eur_str }}€</span> / {{ current_variant.compare_at_price | money }}{% if section.settings.show_price_per_unit %}/пакет{% endif %}
                    {% else %}
                      {{ current_variant.compare_at_price | money }}{% if section.settings.show_price_per_unit %}/пакет{% endif %}
                    {% endif %}
                  {% endif %}
                </div>
              {% endif %}
              <div class="pfc-price" id="pfc-price-{{ section.id }}">
                {% if current_variant.unit_price != blank %}
                  {% comment %} Primary: Unit price per m² {% endcomment %}
                  {% if section.settings.enable_currency_conversion and section.settings.show_eur_alongside_bgn %}
                    {% assign eur_rate = section.settings.eur_to_bgn_rate | default: "1.95583" | plus: 0.0 %}
                    {% assign unit_price_bgn = current_variant.unit_price | divided_by: 100.0 %}
                    {% assign unit_price_eur = unit_price_bgn | divided_by: eur_rate | round: 2 %}
                    {% assign eur_str = unit_price_eur | append: '' %}
                    {% if eur_str contains '.' %}
                      {% assign eur_parts = eur_str | split: '.' %}
                      {% assign dec = eur_parts[1] %}
                      {% if dec.size == 1 %}{% assign dec = dec | append: '0' %}{% endif %}
                      {% assign eur_str = eur_parts[0] | append: '.' | append: dec %}
                    {% else %}
                      {% assign eur_str = eur_str | append: '.00' %}
                    {% endif %}
                    <span class="pfc-price-eur">{{ eur_str }}€</span>/{{ section.settings.unit_label | default: "m²" }}-{{ unit_price_bgn | round: 2 }} лв/{{ section.settings.unit_label | default: "m²" }}
                  {% else %}
                    {{ current_variant.unit_price | money }}/{{ section.settings.unit_label | default: "m²" }}
                  {% endif %}
                  {% comment %} Secondary: Package price {% endcomment %}
                  {% unless section.settings.hide_package_price_top %}
                    <br><small>
                      {% if section.settings.enable_currency_conversion and section.settings.show_eur_alongside_bgn %}
                        {% assign package_price_bgn = current_variant.price | divided_by: 100.0 %}
                        {% assign package_price_eur = package_price_bgn | divided_by: eur_rate | round: 2 %}
                        {% assign eur_str = package_price_eur | append: '' %}
                        {% if eur_str contains '.' %}
                          {% assign eur_parts = eur_str | split: '.' %}
                          {% assign dec = eur_parts[1] %}
                          {% if dec.size == 1 %}{% assign dec = dec | append: '0' %}{% endif %}
                          {% assign eur_str = eur_parts[0] | append: '.' | append: dec %}
                        {% else %}
                          {% assign eur_str = eur_str | append: '.00' %}
                        {% endif %}
                        <span class="pfc-price-eur">{{ eur_str }}€</span> / {{ current_variant.price | money }}/пакет
                      {% else %}
                        {{ current_variant.price | money }}/пакет
                      {% endif %}
                    </small>
                  {% endunless %}
                {% else %}
                  {% comment %} Fallback if unit_price not available {% endcomment %}
                  {% if section.settings.enable_currency_conversion and section.settings.show_eur_alongside_bgn %}
                    {% assign eur_rate = section.settings.eur_to_bgn_rate | default: "1.95583" | plus: 0.0 %}
                    {% assign price_bgn = current_variant.price | divided_by: 100.0 %}
                    {% assign price_eur = price_bgn | divided_by: eur_rate | round: 2 %}
                    {% assign eur_str = price_eur | append: '' %}
                    {% if eur_str contains '.' %}
                      {% assign eur_parts = eur_str | split: '.' %}
                      {% assign dec = eur_parts[1] %}
                      {% if dec.size == 1 %}{% assign dec = dec | append: '0' %}{% endif %}
                      {% assign eur_str = eur_parts[0] | append: '.' | append: dec %}
                    {% else %}
                      {% assign eur_str = eur_str | append: '.00' %}
                    {% endif %}
                    <span class="pfc-price-eur">{{ eur_str }}€</span> / {{ current_variant.price | money }}{% if section.settings.show_price_per_unit %}/пакет{% endif %}
                  {% else %}
                    {{ current_variant.price | money }}{% if section.settings.show_price_per_unit %}/пакет{% endif %}
                  {% endif %}
                {% endif %}
              </div>
            {% elsif section.settings.manual_price != blank %}
              <div class="pfc-price">{{ section.settings.manual_price }}</div>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}

      {% if p != blank and current_variant != blank %}
        <div class="pfc-stock-info">
          <div class="pfc-stock-badge" id="pfc-stock-{{ section.id }}">
            {% if current_variant.available %}
              <span class="pfc-stock-badge--in-stock">{{ section.settings.in_stock_label | default: 'In stock' }}</span>
            {% else %}
              <span class="pfc-stock-badge--out-of-stock">{{ section.settings.out_of_stock_label | default: 'Out of stock' }}</span>
            {% endif %}
          </div>
          {% if section.settings.show_delivery_info %}
            <div class="pfc-delivery">
              {{ section.settings.delivery_text | default: 'Delivery in 3–5 days' }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% comment %} Метафилдите в pfc-info - показват се САМО на мобилни устройства, между delivery и sample-link {% endcomment %}
      {% render 'pfc-metafields-mobile', p: p, section: section, product: product %}

      {% render 'pfc-sample-link', sample_product: sample_product, sample_limit: sample_limit, section: section, product: product %}

      {% if p != blank and p.variants.size > 1 %}
        <div class="pfc-variants">
          {% for option in p.options_with_values %}
            <div class="pfc-variant-option">
              <label for="pfc-option-{{ section.id }}-{{ forloop.index }}" class="pfc-variant-label">
                {{ option.name }}
              </label>
              <select 
                class="pfc-variant-select" 
                id="pfc-option-{{ section.id }}-{{ forloop.index }}"
                data-option-index="{{ option.position }}"
                data-section-id="{{ section.id }}"
              >
                {% for value in option.values %}
                  <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
                    {{ value }}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% comment %} Стандартна форма за добавяне в количката - показва се САМО когато калкулаторът е изключен {% endcomment %}
      {% unless show_calculator_flag %}
      {% if p != blank and current_variant != blank %}
        <form method="post"
              action="{{ routes.cart_add_url }}"
              enctype="multipart/form-data"
              class="pfc-add-to-cart-form"
              id="pfc-add-to-cart-{{ section.id }}"
        >

          <input type="hidden" name="id" value="{{ current_variant.id }}">

          <div class="pfc-qty-wrapper">
            <label for="pfc-qty-standard-{{ section.id }}">{{ section.settings.qty_label | default: "Количество" }}</label>
            <div class="pfc-qty-controls">
              <button type="button" class="pfc-qty-btn" data-action="decrease" aria-label="Намали">−</button>
              <input 
                id="pfc-qty-standard-{{ section.id }}"
                type="number"
                name="quantity"
                value="1"
                min="1"
                step="1"
                class="pfc-qty-input"
                aria-label="Количество"
              >
              <button type="button" class="pfc-qty-btn" data-action="increase" aria-label="Увеличи">+</button>
            </div>
          </div>

          <button type="submit" class="pfc-add-to-cart-btn">
            {{ section.settings.add_to_cart_label | default: "Добави в количката" }}
          </button>

        </form>
      {% endif %}
      {% endunless %}

      {% comment %} Калкулаторът се показва според show_calculator_flag {% endcomment %}
      {% if show_calculator_flag and p != blank and is_sample == false %}
        {% render "pfc-calculator", p: p, section: section, current_variant: current_variant, show_promotional_addon_flag: show_promotional_addon_flag, show_category_block_flag: show_category_block_flag, is_sample: is_sample, product: product %}
      {% endif %}

      {% if section.settings.show_payment_icons %}
        <div class="pfc-payment-icons">
          {% if section.settings.payment_icons_text != blank %}
            <div class="pfc-payment-icons__label">{{ section.settings.payment_icons_text }}</div>
          {% endif %}
          <div class="pfc-payment-icons__list">
            {% assign payment_icon_blocks = section.blocks | where: 'type', 'payment_icon' %}
            {% if payment_icon_blocks.size > 0 %}
              {% for block in payment_icon_blocks %}
                {% if block.settings.icon != blank %}
                  <div class="pfc-payment-icon">
                    <img src="{{ block.settings.icon | image_url: width: 60 }}" alt="{{ block.settings.alt | default: 'Payment method' | escape }}" loading="lazy" decoding="async" width="60" height="40">
                  </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
        </div>
      {% endif %}

      {% assign addon_blocks = section.blocks | where: 'type', 'addon' %}
      {% if addon_blocks.size > 0 %}
        <div class="pfc-addons">
          {% for block in addon_blocks %}
            <div class="pfc-addon">
              {% if block.settings.icon != blank %}
                <div class="pfc-addon__icon">
                  <img src="{{ block.settings.icon | image_url: width: 100 }}" alt="{{ block.settings.title | escape }}" loading="lazy" decoding="async" width="100" height="100">
                </div>
              {% endif %}
              <div class="pfc-addon__content">
                <div class="pfc-addon__title">{{ block.settings.title }}</div>
                {% if block.settings.subtitle != blank %}
                  <div class="pfc-addon__subtitle">{{ block.settings.subtitle }}</div>
                {% endif %}
              </div>
              {% if block.settings.link != blank %}
                <a href="{{ block.settings.link }}" class="pfc-addon__btn">
                  {{ block.settings.link_label | default: 'More' }}
                </a>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}

    </div>
    </div>


  <style>
    /* Performance: font-display swap for faster text rendering */
    @font-face {
      font-display: swap;
    }
    
    .pfc-section {
      margin: 40px auto;
      padding: 0 20px;
      touch-action: pan-y;
    }


    .pfc-grid {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 24px;
      align-items: start;
    }

    .pfc-gallery {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .pfc-gallery__main {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      position: relative;
      width: 100%;
      max-width: 450px;
      margin: 0;
    }

    .pfc-gallery__main-wrapper {
      position: relative;
      width: 100%;
    }

    .pfc-gallery__nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #e5e7eb;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 15;
      transition: all 0.2s ease;
      color: #374151;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .pfc-gallery__nav-btn:hover {
      background: #fff;
      border-color: #ff6a00;
      color: #ff6a00;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: translateY(-50%) scale(1.1);
    }

    .pfc-gallery__nav-btn:active {
      transform: translateY(-50%) scale(0.95);
    }

    .pfc-gallery__nav-btn--prev {
      left: 12px;
    }

    .pfc-gallery__nav-btn--next {
      right: 12px;
    }

    .pfc-gallery__nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      pointer-events: none;
    }

    .pfc-gallery__nav-btn svg {
      width: 20px;
      height: 20px;
      display: block;
    }

    .pfc-image-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #dc2626;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .pfc-gallery__main-img,
    .pfc-gallery__placeholder {
      width: 100%;
      max-width: 100%;
      height: auto;
      display: block;
      aspect-ratio: 1 / 1;
      max-height: 450px;
      object-fit: cover;
      background-color: #f5f5f5;
      transition: opacity 0.3s ease;
      will-change: opacity;
      content-visibility: auto;
      opacity: 1;
    }
    
    .pfc-gallery__main-img[src=""],
    .pfc-gallery__main-img:not([src]) {
      opacity: 0;
    }

    .pfc-gallery__zoom-btn {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 15;
      transition: all 0.2s ease;
      color: #374151;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .pfc-gallery__zoom-btn:hover {
      background: #fff;
      border-color: #ff6a00;
      color: #ff6a00;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: scale(1.1);
    }

    .pfc-gallery__zoom-btn:active {
      transform: scale(0.95);
    }

    .pfc-gallery__zoom-btn svg {
      width: 18px;
      height: 18px;
      display: block;
    }

    .pfc-gallery__zoom-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: pointer;
    }

    .pfc-gallery__zoom-modal.is-open {
      display: flex;
    }

    .pfc-gallery__zoom-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      cursor: default;
    }

    .pfc-gallery__zoom-modal-content img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .pfc-gallery__zoom-modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #374151;
      font-size: 24px;
      line-height: 1;
      transition: all 0.2s ease;
    }

    .pfc-gallery__zoom-modal-close:hover {
      background: #fff;
      color: #ff6a00;
      transform: scale(1.1);
    }

    .pfc-gallery__placeholder {
      background: #f9fafb;
      padding: 40px;
    }

    .pfc-gallery__thumbs-wrapper {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      width: 100%;
      position: relative;
    }

    .pfc-gallery__thumbs-nav {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #e5e7eb;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #374151;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
      z-index: 5;
    }

    .pfc-gallery__thumbs-nav:hover {
      background: #fff;
      border-color: #ff6a00;
      color: #ff6a00;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      transform: scale(1.1);
    }

    .pfc-gallery__thumbs-nav:active {
      transform: scale(0.95);
    }

    .pfc-gallery__thumbs-nav:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      pointer-events: none;
    }

    .pfc-gallery__thumbs-nav svg {
      width: 16px;
      height: 16px;
      display: block;
    }

    .pfc-gallery__thumbs {
      display: flex;
      flex-direction: row;
      gap: 12px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 8px;
      width: 100%;
      flex: 1;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: auto;
      touch-action: pan-x;
      contain: layout style paint;
    }

    .pfc-gallery__thumbs::-webkit-scrollbar {
      height: 4px;
    }

    .pfc-gallery__thumbs::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }

    .pfc-gallery__thumbs::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 2px;
    }

    .pfc-gallery__thumbs::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    .pfc-gallery__thumb {
      background: #fff;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 0;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s ease;
      aspect-ratio: 1;
      min-width: 80px;
      width: 80px;
      min-height: 80px;
      height: 80px;
      flex-shrink: 0;
    }

    .pfc-gallery__thumb:hover {
      border-color: #ff6a00;
      transform: scale(1.05);
    }

    .pfc-gallery__thumb.is-active {
      border-color: #ff6a00;
      box-shadow: 0 0 0 2px rgba(255, 106, 0, 0.2);
    }

    .pfc-gallery__thumb[aria-current="true"] {
      border-color: #ff6a00;
      box-shadow: 0 0 0 2px rgba(255, 106, 0, 0.2);
    }

    .pfc-gallery__thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      pointer-events: none;
      loading: lazy;
      decoding: async;
    }

    .pfc-info {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .pfc-kicker {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6b7280;
      margin-bottom: -8px;
    }


    .pfc-metafields {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
      margin-bottom: 16px;
    }
    
    /* На desktop: скриваме метафилдите в pfc-info (мобилна версия) */
    .pfc-metafields--mobile-only {
      display: none !important;
    }

    .pfc-metafield {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      min-height: 44px;
    }
    .pfc-metafield--empty {
      opacity: 0.7;
      border-style: dashed;
    }
    .pfc-metafield__empty {
      color: #9ca3af;
      font-style: italic;
    }

    .pfc-metafield__label {
      font-weight: 600;
      color: #374151;
      flex-shrink: 0;
    }

    .pfc-metafield__value {
      color: #6b7280;
      flex: 1;
    }

    .pfc-metafield__value img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }

    .pfc-metafield__list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .pfc-metafield__list li {
      padding: 4px 0;
    }

    .pfc-metafield__color {
      margin-right: 8px;
      vertical-align: middle;
    }

    .pfc-metafield__rating {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pfc-metafield__star {
      color: #d1d5db;
      font-size: 18px;
      line-height: 1;
    }

    .pfc-metafield__star.is-filled {
      color: #ffc107;
    }

    .pfc-metafield__rating-value {
      margin-left: 4px;
      font-size: 12px;
      color: #6b7280;
    }

    /* Upsell products layout */
    .pfc-upsell-products {
      margin-top: 8px;
      flex-direction: column;
      align-items: stretch;
    }

    .pfc-upsell-products__list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pfc-upsell-products__item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .pfc-upsell-products__image {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      flex-shrink: 0;
    }

    .pfc-upsell-products__info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .pfc-upsell-products__title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      line-height: 1.3;
    }

    .pfc-upsell-products__actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .pfc-upsell-products__qty {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #374151;
    }

    .pfc-upsell-products__qty input[type="number"] {
      width: 50px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      text-align: center;
    }

    .pfc-upsell-products__button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      background: #16a34a;
      color: #ffffff;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 0.15s ease, transform 0.1s ease;
    }

    .pfc-upsell-products__button:hover {
      background: #15803d;
      transform: translateY(-1px);
    }

    .pfc-upsell-products__button:active {
      transform: translateY(0);
    }

    .pfc-metafield__value a {
      color: #ff6a00;
      text-decoration: none;
      font-weight: 600;
    }

    .pfc-metafield__value a:hover {
      text-decoration: underline;
    }

    .pfc-title {
      font-size: 32px;
      line-height: 1.2;
      font-weight: 700;
      margin: 0;
      color: #111827;
      max-width: 100%;
    }

    .pfc-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .pfc-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 13px;
      line-height: 1;
    }

    .pfc-badge--orange {
      background: #fff2e6;
      color: #b45309;
      border: 1px solid #ffd6a8;
    }

    .pfc-badge--green {
      background: #e8f8ee;
      color: #0a7a3e;
      border: 1px solid #bfe8cf;
    }

    .pfc-price-wrapper {
      margin-top: 8px;
    }

    .pfc-price {
      font-size: 32px;
      font-weight: 700;
      color: {{ section.settings.price_unit_color | default: '#111827' }};
      line-height: 1;
    }

    .pfc-price small {
      font-size: 32px;
      font-weight: 700;
      color: {{ section.settings.price_package_color | default: '#111827' }};
    }

    .pfc-price-eur {
      font-size: 32px;
      font-weight: 700;
      color: {{ section.settings.price_eur_color | default: '#111827' }};
      margin-left: 4px;
    }

    .pfc-price-compare {
      font-size: 32px;
      font-weight: 700;
      color: {{ section.settings.price_compare_color | default: '#9ca3af' }};
      text-decoration: line-through;
      margin-right: 12px;
    }

    .pfc-price-compare small {
      color: {{ section.settings.price_package_color | default: '#111827' }};
    }

    .pfc-price-compare .pfc-price-eur {
      color: {{ section.settings.price_eur_color | default: '#111827' }};
    }

    .pfc-price-compare small {
      font-size: 32px;
      font-weight: 700;
    }

    .pfc-price-compare .pfc-price-eur {
      font-size: 32px;
      font-weight: 700;
    }

    .pfc-stock-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .pfc-stock-badge {
      display: inline-block;
    }

    .pfc-stock-badge--in-stock {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      background: #e8f8ee;
      color: #0a7a3e;
      border: 1px solid #bfe8cf;
      border-radius: 20px;
      font-weight: 600;
      font-size: 13px;
    }

    .pfc-stock-badge--out-of-stock {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
      border-radius: 20px;
      font-weight: 600;
      font-size: 13px;
    }

    .pfc-delivery {
      font-size: 14px;
      color: #6b7280;
    }

    .pfc-variants {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .pfc-variant-label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
      color: #374151;
    }

    .pfc-variant-select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 15px;
      background: #fff;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .pfc-variant-select:hover {
      border-color: #ff6a00;
    }

    .pfc-variant-select:focus {
      outline: none;
      border-color: #ff6a00;
      box-shadow: 0 0 0 3px rgba(255, 106, 0, 0.1);
    }

    .pfc-form {
      margin-top: 20px;
    }

    .pfc-form-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .pfc-qty-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pfc-qty-label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }

    .pfc-qty-controls {
      display: flex;
      align-items: center;
      border: 1px solid rgba(18, 18, 18, 0.2);
      border-radius: 50px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .pfc-qty-btn {
      background: transparent;
      border: none;
      width: 40px;
      height: 44px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 400;
      color: {{ section.settings.calculator_button_color | default: '#111827' }};
      opacity: 0.75;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .pfc-qty-btn:hover {
      background: rgba(18, 18, 18, 0.05);
      color: {{ section.settings.calculator_button_color | default: '#111827' }};
      opacity: 1;
    }

    .pfc-qty-btn:active {
      background: rgba(18, 18, 18, 0.1);
    }

    .pfc-qty-input {
      width: 60px;
      height: 44px;
      border: none;
      border-left: 1px solid rgba(18, 18, 18, 0.1);
      border-right: 1px solid rgba(18, 18, 18, 0.1);
      text-align: center;
      font-size: 16px;
      font-weight: 400;
      color: {{ section.settings.calculator_value_color | default: '#111827' }};
      -moz-appearance: textfield;
      padding: 0;
      background: transparent;
    }

    .pfc-qty-input::-webkit-outer-spin-button,
    .pfc-qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .pfc-add-to-cart-btn {
      width: 100%;
      padding: 12px 24px;
      border-radius: 50px;
      background: rgba(18, 18, 18, 1);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      margin-top: 12px;
    }

    .pfc-add-to-cart-btn:hover {
      background: rgba(18, 18, 18, 0.85);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    .pfc-add-to-cart-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .pfc-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
      min-height: 40px;
      flex: 1;
    }

    .pfc-btn--primary {
      background: {{ section.settings.button_primary_bg | default: '#18a957' }};
      color: {{ section.settings.button_primary_text | default: '#ffffff' }};
      border: 1px solid {{ section.settings.button_primary_border | default: '#0e8d46' }};
    }

    .pfc-btn--primary:hover:not(:disabled) {
      background: {{ section.settings.button_primary_hover | default: '#159348' }};
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .pfc-btn--primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .pfc-btn--secondary {
      background: {{ section.settings.button_secondary_bg | default: '#ff6a00' }};
      color: {{ section.settings.button_secondary_text | default: '#ffffff' }};
      border: 1px solid {{ section.settings.button_secondary_border | default: '#e05400' }};
    }

    .pfc-btn--secondary:hover {
      background: {{ section.settings.button_secondary_hover | default: '#e55f00' }};
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .pfc-checklist {
      list-style: none;
      padding: 0;
      margin: 20px 0 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pfc-checklist__item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 15px;
      color: #374151;
    }

    .pfc-checklist__icon {
      flex-shrink: 0;
      margin-top: 2px;
    }

    .pfc-addons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    .pfc-addon {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: #fafafa;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .pfc-addon:hover {
      border-color: #ff6a00;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .pfc-addon__icon {
      width: 40px;
      height: 40px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pfc-addon__icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .pfc-addon__content {
      flex: 1;
    }

    .pfc-addon__title {
      font-weight: 700;
      font-size: 15px;
      color: #111827;
      margin-bottom: 2px;
    }

    .pfc-addon__subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .pfc-addon__btn {
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      text-decoration: none;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .pfc-addon__btn:hover {
      border-color: #ff6a00;
      color: #ff6a00;
    }

    .pfc-accordion {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 450px;
    }

    .pfc-accordion__item {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }

    .pfc-accordion__header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 18px;
      background: #f9fafb;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 15px;
      color: #111827;
      text-align: left;
      transition: background 0.2s;
    }

    .pfc-accordion__header:hover {
      background: #f3f4f6;
    }

    .pfc-accordion__icon {
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }

    .pfc-accordion__item.is-open .pfc-accordion__icon {
      transform: rotate(180deg);
    }

    .pfc-accordion__panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .pfc-accordion__item.is-open .pfc-accordion__panel {
      max-height: 1000px;
    }

    .pfc-accordion__content {
      padding: 18px;
      color: #6b7280;
      font-size: 14px;
      line-height: 1.6;
    }

    .pfc-collection-slider {
      margin-top: 3px;
      padding: 0;
      background: transparent;
      border-radius: 0;
      margin-left: -4px;
    }
    .pfc-collection-slider__title {
      font-size: 1rem;
      font-weight: 700;
      margin: 0 0 8px;
      color: #111827;
      text-align: center;
      text-transform: uppercase;
      padding: 0;
    }
    .pfc-collection-slider__wrapper {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      position: relative;
    }
    .pfc-collection-slider__track {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      overflow-x: hidden;
      overflow-y: auto;
      flex: 1;
      padding: 1px 0;
      min-width: 0;
      scrollbar-width: thin;
      scrollbar-color: #d1d5db transparent;
      max-height: 700px;
      align-content: flex-start;
      scroll-behavior: auto;
      touch-action: pan-y;
    }
    .pfc-collection-slider__track::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .pfc-collection-slider__track::-webkit-scrollbar-track {
      background: transparent;
    }
    .pfc-collection-slider__track::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
    .pfc-collection-slider__arrow {
      border: none;
      background: #fff;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      cursor: pointer;
      flex-shrink: 0;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      transition: all 0.2s ease;
      z-index: 2;
      align-self: center;
    }
    .pfc-collection-slider__arrow:hover {
      background: #f9fafb;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
      transform: scale(1.05);
    }
    
    /* Upsell products slider */
    .upsell-products {
      margin-top: 10px;
      padding: 0;
      width: 100%;
      max-width: 450px;
    }
    
    .upsell-products__title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #111827;
      text-align: center;
    }
    
    .upsell-products .pfc-collection-slider {
      margin-top: 0;
      margin-left: 0;
    }
    
    .upsell-products .pfc-collection-slider__track {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      flex: 1;
      padding: 2px 0;
      min-width: 0;
      scrollbar-width: thin;
      scrollbar-color: #d1d5db transparent;
      max-height: none;
      align-content: flex-start;
      scroll-behavior: smooth;
      touch-action: pan-x;
    }
    
    .upsell-products .pfc-collection-slider__track::-webkit-scrollbar {
      height: 4px;
      width: 4px;
    }
    
    .upsell-products .pfc-collection-slider__track::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .upsell-products .pfc-collection-slider__track::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 2px;
    }
    
    .upsell-products .pfc-collection-card {
      width: calc(50% - 4px);
      min-width: calc(50% - 4px);
      max-width: calc(50% - 4px);
      flex-shrink: 0;
      flex-grow: 0;
    }
    
    .upsell-products .pfc-collection-card__image-wrapper {
      aspect-ratio: 1 / 1;
      overflow: hidden;
      background: #f5f5f5;
      position: relative;
    }
    
    .upsell-products .pfc-collection-card__body {
      padding: 10px;
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 6px;
    }
    
    .upsell-products .pfc-collection-card__title {
      font-size: 0.85rem;
      margin: 0;
      line-height: 1.3;
      min-height: 1.4em;
      font-weight: 600;
    }
    
    .upsell-products .pfc-collection-card__price-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }
    
    .upsell-products .pfc-collection-card__price-compare {
      font-size: 0.75rem;
      color: #9ca3af;
      text-decoration: line-through;
    }
    
    .upsell-products .pfc-collection-card__price {
      font-weight: 700;
      font-size: 0.9rem;
      color: #111827;
    }
    
    .upsell-products .pfc-collection-card__form {
      margin: 0;
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .upsell-products .pfc-collection-card__qty-wrapper {
      margin-top: 4px;
    }
    
    .upsell-products .pfc-collection-card__qty-controls {
      display: flex;
      align-items: center;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      overflow: hidden;
      background: #fff;
      max-width: 70px;
    }
    
    .upsell-products .pfc-collection-card__qty-btn {
      background: #f9fafb;
      border: none;
      width: 24px;
      min-width: 24px;
      height: 24px;
      min-height: 24px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .upsell-products .pfc-collection-card__qty-input {
      width: 28px;
      min-width: 28px;
      height: 20px;
      min-height: 20px;
      border: none;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      -moz-appearance: textfield;
      padding: 0;
    }
    
    .upsell-products .pfc-collection-card__btn {
      width: 100%;
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 6px;
      background: {{ section.settings.button_collection_bg | default: '#18a957' }};
      color: {{ section.settings.button_collection_text | default: '#ffffff' }};
      text-decoration: none;
      text-align: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 4px;
    }
    
    .upsell-products__grid .pfc-collection-card {
      width: 100%;
      min-width: 0;
      max-width: 100%;
      flex-shrink: 0;
      flex-grow: 0;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.2s ease;
    }
    .pfc-collection-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
      border-color: #d1d5db;
    }
    .pfc-collection-card__image-link {
      display: block;
      position: relative;
      overflow: hidden;
    }
    .upsell-products__grid .pfc-collection-card__image-wrapper {
      aspect-ratio: 1 / 1;
      overflow: hidden;
      background: #f5f5f5;
      position: relative;
    }
    
    .pfc-collection-card__image-wrapper {
      aspect-ratio: 4 / 3;
      overflow: hidden;
      background: #f5f5f5;
      position: relative;
    }
    .pfc-collection-card__image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform .4s ease;
      display: block;
    }
    .pfc-collection-card:hover .pfc-collection-card__image {
      transform: scale(1.08);
    }
    .pfc-collection-card__badge {
      position: absolute;
      top: 6px;
      right: 6px;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 700;
      z-index: 1;
    }
    .pfc-collection-card__badge--sold-out {
      background: #dc2626;
      color: #fff;
    }
    .upsell-products__grid .pfc-collection-card__body {
      padding: 6px;
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 3px;
    }
    
    .pfc-collection-card__body {
      padding: 3px 5px 5px;
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 1px;
    }
    
    .upsell-products__grid .pfc-collection-card__title {
      font-size: 0.7rem;
      margin: 0;
      line-height: 1.15;
      min-height: 1.1em;
    }
    
    .pfc-collection-card__title {
      font-size: 0.85rem;
      margin: 0;
      line-height: 1.3;
      min-height: 1.4em;
    }
    .pfc-collection-card__title a {
      color: #111827;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s ease;
    }
    .pfc-collection-card__title a:hover {
      color: #ff6a00;
    }
    
    .upsell-products__grid .pfc-collection-card__price-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }
    
    .upsell-products__grid .pfc-collection-card__price-compare {
      font-size: 0.65rem;
      color: #9ca3af;
      text-decoration: line-through;
    }
    
    .upsell-products__grid .pfc-collection-card__price {
      font-weight: 700;
      font-size: 0.75rem;
      color: #111827;
    }
    
    .pfc-collection-card__price-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .pfc-collection-card__price-compare {
      font-size: 0.8rem;
      color: #9ca3af;
      text-decoration: line-through;
    }
    .pfc-collection-card__price {
      font-weight: 700;
      font-size: 0.9rem;
      color: #111827;
    }
    .upsell-products__grid .pfc-collection-card__form {
      margin: 0;
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .pfc-collection-card__form {
      margin: 0;
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .upsell-products__grid .pfc-collection-card__qty-wrapper {
      margin-top: 4px;
    }
    
    .pfc-collection-card__qty-wrapper {
      margin-top: 8px;
    }
    
    .upsell-products__grid .pfc-collection-card__qty-controls {
      display: flex;
      align-items: center;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      overflow: hidden;
      background: #fff;
      max-width: 70px;
    }
    
    .pfc-collection-card__qty-controls {
      display: flex;
      align-items: center;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      max-width: 90px;
    }
    
    .upsell-products__grid .pfc-collection-card__qty-btn {
      background: #f9fafb;
      border: none;
      width: 20px;
      min-width: 20px;
      height: 20px;
      min-height: 20px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      color: #374151;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .pfc-collection-card__qty-btn {
      background: #f9fafb;
      border: none;
      width: 24px;
      min-width: 24px;
      height: 24px;
      min-height: 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .pfc-collection-card__qty-btn:hover {
      background: #f3f4f6;
    }
    .pfc-collection-card__qty-btn:active {
      background: #e5e7eb;
    }
    .upsell-products .pfc-collection-card__qty-input {
      width: 28px;
      min-width: 28px;
      height: 20px;
      min-height: 20px;
      border: none;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      -moz-appearance: textfield;
      padding: 0;
    }
    
    .upsell-products .pfc-collection-card__qty-input {
      width: 28px;
      min-width: 28px;
      height: 20px;
      min-height: 20px;
      border: none;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      -moz-appearance: textfield;
      padding: 0;
    }
    
    .upsell-products__grid .pfc-collection-card__qty-input {
      width: 28px;
      min-width: 28px;
      height: 20px;
      min-height: 20px;
      border: none;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      text-align: center;
      font-size: 10px;
      font-weight: 600;
      -moz-appearance: textfield;
      padding: 0;
    }
    
    .pfc-collection-card__qty-input {
      width: 35px;
      min-width: 35px;
      height: 24px;
      min-height: 24px;
      border: none;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      -moz-appearance: textfield;
      padding: 0;
    }
    .pfc-collection-card__qty-input::-webkit-outer-spin-button,
    .pfc-collection-card__qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .upsell-products__grid .pfc-collection-card__btn {
      width: 100%;
      display: block;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 5px 8px;
      border-radius: 4px;
      background: {{ section.settings.button_collection_bg | default: '#18a957' }};
      color: {{ section.settings.button_collection_text | default: '#ffffff' }};
      text-decoration: none;
      text-align: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 2px;
    }
    
    .pfc-collection-card__btn {
      width: 100%;
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 4px;
      background: {{ section.settings.button_collection_bg | default: '#18a957' }};
      color: {{ section.settings.button_collection_text | default: '#ffffff' }};
      text-decoration: none;
      text-align: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 4px;
    }
    .pfc-collection-card__btn:hover {
      background: {{ section.settings.button_collection_hover | default: '#15803d' }};
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .pfc-collection-card__btn--disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .pfc-collection-card__btn--disabled:hover {
      background: #9ca3af;
      transform: none;
      box-shadow: none;
    }

    .pfc-complete-set {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      margin-top: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .pfc-complete-set__savings {
      background: #dc2626;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      text-align: center;
      margin-bottom: 16px;
    }

    .pfc-complete-set__product {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    .pfc-complete-set__product-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      flex-shrink: 0;
    }

    .pfc-complete-set__product-info {
      flex: 1;
    }

    .pfc-complete-set__product-title {
      font-weight: 600;
      font-size: 15px;
      color: #111827;
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .pfc-complete-set__price {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pfc-complete-set__price-compare {
      font-size: 32px;
      font-weight: 700;
      color: {{ section.settings.price_compare_color | default: '#9ca3af' }};
      text-decoration: line-through;
    }

    .pfc-complete-set__price-compare .pfc-price-eur {
      font-size: 32px;
      font-weight: 700;
      color: {{ section.settings.price_eur_color | default: '#111827' }};
    }

    .pfc-complete-set__price-current {
      font-size: 32px;
      font-weight: 700;
      color: {{ section.settings.price_calculator_color | default: '#111827' }};
    }

    .pfc-complete-set__price-current small {
      font-size: 14px;
      font-weight: 500;
      display: block;
      margin-top: 4px;
      color: {{ section.settings.price_package_color | default: '#111827' }};
    }

    .pfc-complete-set__price-current .pfc-price-eur {
      font-size: 32px;
      font-weight: 700;
      color: {{ section.settings.price_eur_color | default: '#111827' }};
    }

    .pfc-complete-set__price-current small .pfc-price-eur {
      font-size: 14px;
      font-weight: 500;
      color: {{ section.settings.price_eur_color | default: '#111827' }};
    }

    .pfc-complete-set__qty {
      margin-bottom: 12px;
    }

    .pfc-complete-set__qty-label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      color: {{ section.settings.calculator_label_color | default: '#374151' }};
    }

    .pfc-qty-info {
      font-size: 13px;
      font-style: italic;
      color: #6b7280;
      margin-bottom: 12px;
      line-height: 1.5;
      padding: 8px 12px;
      background: #f9fafb;
      border-radius: 6px;
      border-left: 3px solid #18a957;
    }

    .pfc-complete-set__packages {
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      color: {{ section.settings.calculator_value_color | default: '#111827' }};
      line-height: 1.4;
    }

    .pfc-complete-set__roof-area {
      margin-top: 8px;
      font-size: 14px;
      color: {{ section.settings.calculator_label_color | default: '#374151' }};
      line-height: 1.5;
    }

    .pfc-complete-set__roof-area span {
      font-weight: 500;
      color: {{ section.settings.calculator_value_color | default: '#111827' }};
    }

    .pfc-complete-set__waste {
      margin-bottom: 12px;
    }

    .pfc-waste-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #374151;
    }

    .pfc-waste-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .pfc-waste-info {
      font-size: 12px;
      opacity: 0.7;
      cursor: pointer;
      position: relative;
    }

    .pfc-waste-tooltip {
      display: none;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 125%;
      background: #111827;
      color: #f9fafb;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: normal;
      max-width: 240px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      z-index: 20;
    }

    .pfc-waste-tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 6px;
      border-style: solid;
      border-color: #111827 transparent transparent transparent;
    }

    .pfc-complete-set__package-details {
      font-size: 14px;
      color: {{ section.settings.calculator_package_info_color | default: '#6b7280' }};
      margin-bottom: 16px;
      padding: 14px 16px;
      background: #f9fafb;
      border-radius: 8px;
      line-height: 1.6;
      font-weight: 400;
    }

    .pfc-complete-set__package-details span {
      font-weight: 500;
      color: {{ section.settings.calculator_value_color | default: '#111827' }};
    }

    #pfc-package-price-{{ section.id }} {
      color: {{ section.settings.calculator_value_color | default: '#111827' }};
    }

    #pfc-package-price-{{ section.id }} .pfc-price-eur {
      color: {{ section.settings.price_eur_color | default: '#111827' }};
    }

    .pfc-complete-set__total {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .pfc-complete-set__total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .pfc-complete-set__total-row > span:first-child {
      font-weight: 600;
      font-size: 16px;
      color: {{ section.settings.calculator_total_label_color | default: '#374151' }};
    }

    .pfc-complete-set__total-prices {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pfc-complete-set__total-compare {
      font-size: 18px;
      color: {{ section.settings.price_compare_color | default: '#9ca3af' }};
      text-decoration: line-through;
    }

    .pfc-complete-set__total-compare .pfc-price-eur {
      color: {{ section.settings.price_eur_color | default: '#111827' }};
    }

    .pfc-complete-set__total-current {
      font-size: 24px;
      font-weight: 700;
      color: {{ section.settings.price_total_color | default: '#18a957' }};
    }

    .pfc-complete-set__total-current .pfc-price-eur {
      color: {{ section.settings.price_eur_color | default: '#111827' }};
    }

    .pfc-complete-set__total-savings {
      text-align: right;
      font-size: 14px;
      color: #18a957;
      font-weight: 600;
    }

    .pfc-complete-set__promo-addons {
      margin-bottom: 16px;
    }

    .pfc-promo-addon {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 12px;
      background: #fef3c7;
      border: 1px solid #fde68a;
      border-radius: 8px;
      margin-bottom: 8px;
      gap: 12px;
    }

    .pfc-promo-addon__image {
      flex-shrink: 0;
      width: 60px;
      height: 60px;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      border: 1px solid #e5e7eb;
    }

    .pfc-promo-addon__image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .pfc-promo-addon__content {
      flex: 1;
      min-width: 0;
    }

    .pfc-promo-addon__label {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      color: #92400e;
      margin-bottom: 6px;
    }

    .pfc-promo-addon__title {
      font-weight: 600;
      font-size: 16px;
      color: #111827;
      margin-bottom: 8px;
    }

    .pfc-promo-addon__price-wrapper {
      margin-bottom: 10px;
    }

    .pfc-promo-addon__qty {
      font-size: 13px;
      color: #6b7280;
    }

    .pfc-promo-addon__price {
      font-weight: 600;
      color: #18a957;
      font-size: 18px;
    }

    .pfc-promo-addon__form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .pfc-promo-addon__qty-wrapper {
      margin-top: 4px;
    }

    .pfc-promo-addon__qty-controls {
      display: flex;
      align-items: center;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      max-width: 120px;
    }

    .pfc-promo-addon__qty-btn {
      background: #f9fafb;
      border: none;
      width: 32px;
      min-width: 32px;
      height: 32px;
      min-height: 32px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .pfc-promo-addon__qty-btn:hover {
      background: #f3f4f6;
    }

    .pfc-promo-addon__qty-btn:active {
      background: #e5e7eb;
    }

    .pfc-promo-addon__qty-input {
      width: 50px;
      min-width: 50px;
      height: 32px;
      min-height: 32px;
      border: none;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      -moz-appearance: textfield;
      padding: 0;
    }

    .pfc-promo-addon__qty-input::-webkit-outer-spin-button,
    .pfc-promo-addon__qty-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .pfc-promo-addon__btn {
      padding: 10px 16px;
      border-radius: 6px;
      background: #18a957;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      text-align: center;
      max-width: 200px;
    }

    .pfc-promo-addon__btn:hover {
      background: #15803d;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);
    }

    .pfc-promo-addon__unavailable {
      color: #9ca3af;
      font-size: 13px;
      font-weight: 600;
      margin-top: 8px;
    }

    .pfc-promo-addon__change {
      font-size: 13px;
      color: #ff6a00;
      text-decoration: underline;
      white-space: nowrap;
      margin-left: 12px;
    }

    .pfc-complete-set__addon-categories {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .pfc-addon-category {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .pfc-addon-category__title {
      font-weight: 600;
      font-size: 12px;
      color: #374151;
    }

    .pfc-addon-category__btn {
      padding: 6px 16px;
      background: #fff;
      border: 1px solid #ff6a00;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #ff6a00;
      text-decoration: none;
      transition: all 0.2s;
    }

    .pfc-addon-category__btn:hover {
      background: #ff6a00;
      color: #fff;
    }

    .pfc-btn--request-offer {
      width: 100%;
      background: {{ section.settings.button_request_offer_bg | default: '#ffffff' }};
      border: 2px solid {{ section.settings.button_request_offer_border | default: '#ff6a00' }};
      color: {{ section.settings.button_request_offer_text | default: '#ff6a00' }};
      margin-bottom: 12px;
    }

    .pfc-btn--request-offer:hover {
      background: {{ section.settings.button_request_offer_hover_bg | default: '#ff6a00' }};
      color: {{ section.settings.button_request_offer_hover_text | default: '#ffffff' }};
    }

    .pfc-btn--full {
      width: 100%;
    }


    .pfc-action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
      align-items: flex-start;
    }

    .pfc-action-buttons .pfc-btn {
      flex: 0 0 auto;
      width: auto;
      max-width: 100%;
    }

    .pfc-btn--sample {
      background: {{ section.settings.button_sample_bg | default: '#18a957' }};
      color: {{ section.settings.button_sample_text | default: '#ffffff' }};
      border: 1px solid {{ section.settings.button_sample_border | default: '#0e8d46' }};
    }

    .pfc-btn--sample:hover {
      background: {{ section.settings.button_sample_hover | default: '#159348' }};
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .pfc-btn--virtual {
      background: {{ section.settings.button_virtual_bg | default: '#ffffff' }};
      color: {{ section.settings.button_virtual_text | default: '#ff6a00' }};
      border: 2px solid {{ section.settings.button_virtual_border | default: '#ff6a00' }};
    }

    .pfc-btn--virtual:hover {
      background: {{ section.settings.button_virtual_hover | default: '#fff5f0' }};
    }

    .pfc-payment-icons {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .pfc-payment-icons__label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 12px;
      text-align: center;
    }

    .pfc-payment-icons__list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
    }

    .pfc-payment-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .pfc-payment-icon:hover {
      opacity: 1;
    }

    .pfc-payment-icon img {
      max-width: 60px;
      max-height: 40px;
      object-fit: contain;
    }

    /* ===== UX ПОДОБРЕНИЯ ===== */
    
    /* Loading Spinner за бутони */
    .pfc-btn--loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
      opacity: 0.8;
    }

    .pfc-btn--loading::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: pfc-spin 0.6s linear infinite;
    }

    @keyframes pfc-spin {
      to { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .pfc-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #22c55e;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: pfc-slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 10000;
      max-width: 400px;
      font-weight: 500;
      font-size: 14px;
      line-height: 1.5;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pfc-toast--error {
      background: #dc2626;
    }

    .pfc-toast--warning {
      background: #f59e0b;
    }

    .pfc-toast--info {
      background: #3b82f6;
    }

    .pfc-toast--hide {
      animation: pfc-slideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .pfc-toast__icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    @keyframes pfc-slideIn {
      from {
        transform: translateX(calc(100% + 20px));
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes pfc-slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(calc(100% + 20px));
        opacity: 0;
      }
    }

    /* Подобрени Hover Effects */
    .pfc-btn:not(:disabled) {
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .pfc-btn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .pfc-btn:not(:disabled):active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Ripple Effect */
    .pfc-btn::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
      pointer-events: none;
    }

    .pfc-btn:active::before {
      width: 300px;
      height: 300px;
    }

    /* Progress Indicator за мостри */
    /* Подобрени Collection Cards */
    .pfc-collection-card {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                  box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .pfc-collection-card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    /* Focus States за Accessibility */
    .pfc-btn:focus-visible,
    .pfc-input:focus-visible,
    .pfc-gallery__thumb:focus-visible {
      outline: 2px solid #ff6a00;
      outline-offset: 2px;
    }

    /* Error States */
    .pfc-input--error {
      border-color: #dc2626 !important;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .pfc-error-message {
      color: #dc2626;
      font-size: 13px;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Success Checkmark Animation */
    .pfc-btn--success {
      background: #22c55e !important;
      position: relative;
    }

    .pfc-btn--success::after {
      content: "✓";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      animation: pfc-checkmark 0.3s ease;
    }

    @keyframes pfc-checkmark {
      0% {
        transform: translate(-50%, -50%) scale(0);
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
      }
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    @media (max-width: 990px) {
      .pfc-grid {
        grid-template-columns: 1fr;
        gap: 24px;
        display: flex;
        flex-direction: column;
      }
      
      .pfc-gallery {
        display: flex;
        flex-direction: column;
      }
      
      .pfc-gallery > .pfc-collection-slider {
        order: 999;
        margin-top: 20px;
      }
      
      .pfc-gallery > .pfc-gallery__main,
      .pfc-gallery > .pfc-gallery__thumbs-wrapper,
      .pfc-gallery > .pfc-gallery__zoom-modal,
      .pfc-gallery > .pfc-action-buttons,
      .pfc-gallery > .pfc-accordion,
      .pfc-gallery > .pfc-checklist {
        order: 1;
      }
      
      .pfc-section {
        position: relative;
      }
      
      .pfc-grid {
        position: relative;
        padding-bottom: 400px;
      }
      
      .pfc-gallery > .pfc-collection-slider {
        position: absolute;
        top: calc(100% + 20px);
        left: 0;
        right: 0;
        width: 100%;
        margin-top: 0;
        z-index: 1;
      }
      
      .pfc-info {
        position: relative;
        z-index: 0;
      }

      .pfc-gallery__main {
        max-width: 100%;
      }

      .pfc-gallery__main-img,
      .pfc-gallery__placeholder {
        max-height: 350px;
      }

      .pfc-btn {
        padding: 12px 20px;
        font-size: 14px;
        min-height: 44px;
      }
      
      .pfc-add-to-cart-btn {
        padding: 14px 24px;
        font-size: 15px;
        font-weight: 600;
        min-height: 48px;
        letter-spacing: 0.05em;
      }
      
      .pfc-btn--primary {
        padding: 14px 24px;
        font-size: 15px;
        min-height: 48px;
        font-weight: 600;
      }

      .pfc-gallery__thumbs {
        flex-direction: row;
        overflow-x: auto;
        padding-bottom: 8px;
      }

      .pfc-gallery__thumb {
        min-width: 80px;
        width: 80px;
        min-height: 80px;
        height: 80px;
        flex-shrink: 0;
      }

      .pfc-title {
        font-size: 26px;
      }

      .pfc-price {
        font-size: 28px;
      }

      .pfc-form-row {
        flex-direction: column;
      }

      .pfc-btn {
        width: 100%;
      }

      [data-calculator-block] {
        display: block !important;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .pfc-complete-set__promo-addons {
        display: block !important;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .pfc-promo-addon {
        display: flex !important;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

    }

    @media (max-width: 640px) {
      .pfc-upsell-products__item {
        flex-wrap: wrap;
        padding: 12px;
        gap: 12px;
      }
      
      .pfc-upsell-products__image {
        width: 120px;
        height: 120px;
        border-radius: 10px;
      }
      
      .pfc-upsell-products__info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .pfc-upsell-products__title {
        font-size: 14px;
        line-height: 1.3;
        margin-bottom: 0;
      }
      
      .pfc-upsell-products__actions {
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        gap: 10px;
        margin-top: 0;
      }
      
      .pfc-upsell-products__qty {
        flex-shrink: 0;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .pfc-upsell-products__qty input[type="number"] {
        width: 50px;
        padding: 4px 6px;
        font-size: 13px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
      }
      
      .pfc-upsell-products__button {
        flex: 0 0 auto;
        padding: 7px 14px;
        font-size: 12px;
        white-space: nowrap;
        min-width: auto;
        border-radius: 6px;
      }
      
      .pfc-section,
      .pfc-section *,
      .pfc-section *::before,
      .pfc-section *::after {
        box-sizing: border-box;
      }
      
      .pfc-gallery {
        display: flex;
        flex-direction: column;
      }
      
      .pfc-gallery > .pfc-collection-slider {
        order: 999;
        margin-top: 20px;
      }
      
      .pfc-gallery > .pfc-gallery__main,
      .pfc-gallery > .pfc-gallery__thumbs-wrapper,
      .pfc-gallery > .pfc-gallery__zoom-modal,
      .pfc-gallery > .pfc-action-buttons,
      .pfc-gallery > .pfc-accordion,
      .pfc-gallery > .pfc-checklist {
        order: 1;
      }

      .pfc-section {
        padding: 0 8px;
        overflow-x: hidden;
        max-width: 100vw;
        width: 100%;
        margin-left: 0;
        margin-right: 0;
      }

      .pfc-section img {
        max-width: 100% !important;
        height: auto !important;
        width: auto !important;
      }

      .pfc-section > * {
        max-width: 100%;
        overflow-x: hidden;
      }

      .pfc-title {
        font-size: 18px;
        line-height: 1.3;
        margin-bottom: 6px;
      }

      .pfc-kicker {
        font-size: 10px;
        margin-bottom: 3px;
      }

      .pfc-price {
        font-size: 20px;
      }

      .pfc-price small {
        font-size: 20px;
        font-weight: 700;
      }

      .pfc-price-eur {
        font-size: 20px;
        font-weight: 700;
      }

      .pfc-price-compare {
        font-size: 20px;
        font-weight: 700;
      }

      .pfc-price-compare small {
        font-size: 20px;
        font-weight: 700;
      }

      .pfc-price-compare .pfc-price-eur {
        font-size: 20px;
        font-weight: 700;
      }

      .pfc-stock-info {
        margin-top: 8px;
        margin-bottom: 8px;
      }

      .pfc-stock-badge {
        font-size: 12px;
        padding: 6px 10px;
      }

      .pfc-delivery {
        font-size: 12px;
        margin-top: 4px;
      }

      .pfc-gallery {
        gap: 8px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .pfc-gallery__main {
        max-width: 100%;
        width: 100%;
        border-radius: 12px;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
        padding: 0;
        overflow: hidden;
        aspect-ratio: 1 / 1;
        position: relative;
        background-color: #f5f5f5;
      }

      .pfc-gallery__main-wrapper {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        box-sizing: border-box;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        display: block;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }

      .pfc-gallery__main-img,
      .pfc-gallery__placeholder {
        width: 100% !important;
        max-width: 100% !important;
        height: 100% !important;
        min-height: 100% !important;
        max-height: 100% !important;
        object-fit: cover !important;
        object-position: center center !important;
        aspect-ratio: 1 / 1;
        display: block;
        margin: 0;
        padding: 0;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #f5f5f5;
        opacity: 1;
        transition: opacity 0.3s ease;
      }
      
      .pfc-gallery__main-img[src=""],
      .pfc-gallery__main-img:not([src]) {
        opacity: 0;
      }

      .pfc-gallery__nav-btn {
        width: 36px;
        height: 36px;
      }

      .pfc-gallery__nav-btn svg {
        width: 18px;
        height: 18px;
      }

      .pfc-gallery__nav-btn--prev {
        left: 4px;
      }

      .pfc-gallery__nav-btn--next {
        right: 4px;
      }

      .pfc-gallery__zoom-btn {
        top: 8px;
        left: 8px;
        width: 36px;
        height: 36px;
        z-index: 20;
      }

      .pfc-gallery__zoom-btn svg {
        width: 18px;
        height: 18px;
      }

      .pfc-image-badge {
        top: 8px;
        right: 8px;
        left: auto;
        padding: 6px 10px;
        font-size: 12px;
        max-width: calc(100% - 60px);
        word-wrap: break-word;
        white-space: normal;
        line-height: 1.2;
        z-index: 20;
      }

      .pfc-gallery__thumbs-nav {
        width: 28px;
        height: 28px;
      }

      .pfc-gallery__thumbs-nav svg {
        width: 14px;
        height: 14px;
      }

      .pfc-gallery__thumbs {
        padding-bottom: 4px;
      }

      .pfc-gallery__thumb {
        min-width: 55px;
        width: 55px;
        min-height: 55px;
        height: 55px;
      }

      .pfc-btn {
        padding: 6px 12px;
        font-size: 11px;
        min-height: 32px;
        border-radius: 6px;
      }

      .pfc-action-buttons {
        flex-direction: column;
        gap: 10px;
        margin-top: 12px;
        width: 100%;
      }

      .pfc-action-buttons .pfc-btn {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .pfc-info {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      /* Мобилна подредба на елементите */
      .pfc-grid {
        display: flex;
        flex-direction: column;
      }
      
      .pfc-gallery {
        order: 1;
        display: flex;
        flex-direction: column;
      }
      
      .pfc-info {
        order: 2;
        display: flex;
        flex-direction: column;
      }
      
      /* В pfc-info: заглавие и цени остават горе */
      .pfc-info > .pfc-title {
        order: 1;
      }
      
      .pfc-info > .pfc-price-wrapper {
        order: 2;
      }
      
      .pfc-info > .pfc-stock-info {
        order: 3;
      }
      
      .pfc-info > .pfc-delivery-info {
        order: 4;
      }
      
      /* Метафилдите в pfc-info - показват се САМО на мобилни, между delivery и sample-link */
      .pfc-info > .pfc-metafields--mobile-only {
        order: 4.5 !important;
        margin-top: 15px !important;
        margin-bottom: 15px !important;
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .pfc-info > .pfc-sample-link {
        order: 5;
      }
      
      /* Преместваме черния банер извън pfc-info и го поставяме след метафилдите */
      .sample-box {
        order: 7;
        margin-top: 20px !important;
        margin-bottom: 0;
        display: block !important;
      }
      
      /* Преместваме калкулатора извън pfc-info и го поставяме след черния банер (не до него) */
      .pfc-complete-set {
        order: 8;
        margin-top: 20px !important;
        margin-bottom: 0;
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
        padding: 12px;
        margin-top: 12px;
        margin-left: 0;
        margin-right: 0;
        border-radius: 10px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }

      .pfc-complete-set__savings {
        font-size: 11px;
        padding: 5px 8px;
        margin-bottom: 10px;
      }

      .pfc-complete-set__product-title {
        font-size: 14px;
      }

      .pfc-complete-set__price {
        font-size: 12px;
      }

      .pfc-complete-set__price-current {
        font-size: 20px;
        font-weight: 700;
      }

      .pfc-complete-set__price-current small {
        font-size: 12px;
        font-weight: 500;
        display: block;
        margin-top: 4px;
      }

      .pfc-complete-set__price-current .pfc-price-eur {
        font-size: 20px;
        font-weight: 700;
      }

      .pfc-complete-set__price-current small .pfc-price-eur {
        font-size: 12px;
        font-weight: 500;
      }

      .pfc-complete-set__qty-label {
        font-size: 11px;
      }

      .pfc-complete-set__total {
        margin-top: 10px;
      }

      .pfc-complete-set__total-row {
        font-size: 14px;
      }

      .pfc-checklist {
        margin-top: 8px;
        margin-bottom: 8px;
        gap: 6px;
        width: 100%;
      }

      .pfc-checklist__item {
        font-size: 12px;
        padding: 4px 0;
        gap: 6px;
      }

      .pfc-accordion {
        width: 100%;
        max-width: 100%;
        margin-top: 12px;
      }

      .pfc-accordion__header {
        padding: 10px 12px;
        font-size: 12px;
      }

      .pfc-accordion__content {
        font-size: 12px;
        padding: 10px 12px;
      }

      .pfc-promo-addon__qty-controls {
        max-width: 110px;
      }

      .pfc-promo-addon__qty-btn {
        width: 36px;
        min-width: 36px;
        height: 36px;
        min-height: 36px;
        font-size: 18px;
      }

      .pfc-promo-addon__qty-input {
        width: 45px;
        min-width: 45px;
        height: 36px;
        min-height: 36px;
        font-size: 15px;
      }

      .pfc-promo-addon__btn {
        font-size: 12px;
        padding: 10px 14px;
        min-height: 40px;
      }

      [data-calculator-block] {
        display: block !important;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
        overflow: visible;
      }

      .pfc-complete-set__promo-addons {
        display: block !important;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin-bottom: 12px;
        overflow: visible;
      }

      .pfc-promo-addon {
        display: flex !important;
        flex-direction: column;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 10px;
        margin-bottom: 10px;
        gap: 10px;
        overflow: visible;
      }

      .pfc-promo-addon__image {
        width: 50px;
        height: 50px;
        flex-shrink: 0;
      }

      .pfc-promo-addon__content {
        flex: 1;
        min-width: 0;
        width: 100%;
      }

      .pfc-promo-addon__title {
        font-size: 13px;
        margin-bottom: 6px;
      }

      .pfc-promo-addon__price {
        font-size: 13px;
      }

      .pfc-promo-addon__form {
        width: 100%;
        max-width: 100%;
      }

      .pfc-promo-addon__change {
        margin-left: 0;
        margin-top: 8px;
        display: block;
      }

      /* Преместваме ъпсел продуктите под калкулатора */
      .upsell-products {
        order: 8;
        margin-top: 20px !important;
        margin-bottom: 0;
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Уверяваме се, че слайдът се показва правилно на мобилни */
      .pfc-collection-slider {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .pfc-collection-slider__track {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* На мобилни: скриваме метафилдите от pfc-gallery и показваме тези в pfc-info */
      .pfc-gallery .pfc-metafields {
        display: none !important;
      }
      
      /* Показваме метафилдите в pfc-info на мобилни устройства */
      .pfc-metafields--mobile-only {
        display: block !important;
        order: 4.5 !important;
        margin-top: 15px !important;
        margin-bottom: 15px !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .pfc-metafields--mobile-only .pfc-metafield {
        margin-bottom: 8px !important;
        padding-bottom: 8px !important;
      }
      
      .pfc-metafields--mobile-only .pfc-metafield:last-child {
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
      }
      
      /* Показваме ъпсел продуктите в pfc-gallery с flex order */
      .pfc-gallery {
        display: flex;
        flex-direction: column;
      }
      
      /* Показваме ъпсел продуктите в pfc-gallery, но ги преместваме в края с order */
      .pfc-gallery .upsell-products {
        order: 999;
        display: block !important;
        margin-top: 20px !important;
        margin-bottom: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        padding: 0;
      }
      
      /* Уверяваме се, че няма огромни разстояния */
      .pfc-gallery .upsell-products .pfc-collection-slider {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
      }
      
      .pfc-gallery .upsell-products .upsell-products__title {
        margin-top: 0 !important;
        margin-bottom: 10px !important;
      }
      
      /* На мобилни показваме само 2 продукта в grid вместо слайд */
      .pfc-gallery .upsell-products .pfc-collection-slider__track {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        overflow: visible !important;
        flex-wrap: wrap !important;
      }
      
      /* Скриваме стрелките на слайда на мобилни */
      .pfc-gallery .upsell-products .pfc-collection-slider__arrow {
        display: none !important;
      }
      
      /* Ограничаваме до 2 продукта на мобилни */
      .pfc-gallery .upsell-products .pfc-collection-card:nth-child(n+3) {
        display: none !important;
      }
      
      /* Уверяваме се, че картките са правилно разположени */
      .pfc-gallery .upsell-products .pfc-collection-card {
        width: calc(50% - 6px) !important;
        max-width: calc(50% - 6px) !important;
        flex: 0 0 auto !important;
      }
      
      /* Премахнати дублирани правила */
      
      /* Премахваме само sample-box от pfc-info на мобилни, но показваме калкулатора */
      .pfc-info .sample-box {
        display: none !important;
      }
      
      /* Показваме калкулатора в pfc-info с правилния order */
      .pfc-info .pfc-complete-set,
      .pfc-info [data-calculator-block] {
        order: 7;
        display: block !important;
        margin-top: 20px !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Уверяваме се, че калкулаторът не е скрит от други правила */
      .pfc-info [data-calculator-block] .pfc-complete-set {
        display: block !important;
      }

      .pfc-grid {
        gap: 12px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 0;
        margin-left: 0;
        margin-right: 0;
      }
      .pfc-collection-slider {
        padding: 0;
        margin-left: 0;
        margin-right: 0;
        overflow-x: hidden;
        overflow-y: visible;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin-top: 8px;
      }
      .pfc-collection-slider__title {
        font-size: 0.7rem;
        margin-bottom: 6px;
        padding: 0 2px;
      }
      .pfc-collection-slider__wrapper {
        gap: 0;
        width: 100%;
        max-width: 100%;
        position: relative;
        box-sizing: border-box;
        overflow: visible;
      }
      .pfc-collection-slider__arrow {
        display: none !important;
      }
      .pfc-collection-slider__track {
        gap: 8px;
        padding: 2px 4px;
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        display: flex;
        flex-wrap: nowrap;
        touch-action: pan-x;
      }
      .pfc-collection-slider__track::-webkit-scrollbar {
        display: none;
      }
      .pfc-collection-card {
        width: calc(50% - 4px);
        min-width: calc(50% - 4px);
        max-width: calc(50% - 4px);
        box-sizing: border-box;
        flex-shrink: 0;
        overflow: hidden;
      }
      .pfc-collection-card__body {
        padding: 6px 6px 8px;
        box-sizing: border-box;
        width: 100%;
        overflow: hidden;
      }
      .pfc-collection-card__title {
        font-size: 0.7rem;
        min-height: 1.4em;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.3;
      }
      .pfc-collection-card__price {
        font-size: 0.7rem;
      }
      .pfc-collection-card__price-compare {
        font-size: 0.65rem;
      }
      .pfc-collection-card__form {
        width: 100%;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      .pfc-collection-card__qty-controls {
        max-width: 100%;
        margin-top: 4px;
        box-sizing: border-box;
      }
      .pfc-collection-card__qty-btn {
        width: 24px;
        min-width: 24px;
        height: 24px;
        min-height: 24px;
        font-size: 14px;
      }
      .pfc-collection-card__qty-input {
        width: 30px;
        min-width: 30px;
        height: 24px;
        min-height: 24px;
        font-size: 12px;
      }
      .pfc-collection-card__btn {
        font-size: 0.65rem;
        padding: 6px 8px;
        margin-top: 6px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 32px;
        line-height: 1.3;
        word-wrap: break-word;
      }
    }
    @media (max-width: 749px) {
      .pfc-grid {
        display: flex;
        flex-direction: column;
      }
      
      .pfc-gallery {
        display: flex;
        flex-direction: column;
      }
      
      .pfc-gallery > .pfc-collection-slider {
        order: 999;
        margin-top: 20px;
      }
      
      .pfc-gallery > .pfc-gallery__main,
      .pfc-gallery > .pfc-gallery__thumbs-wrapper,
      .pfc-gallery > .pfc-gallery__zoom-modal,
      .pfc-gallery > .pfc-action-buttons,
      .pfc-gallery > .pfc-accordion,
      .pfc-gallery > .pfc-checklist {
        order: 1;
      }
      .pfc-collection-slider {
        padding: 0;
        margin-left: 0;
        margin-right: 0;
        overflow-x: hidden;
        overflow-y: visible;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      .pfc-collection-slider__arrow {
        display: none !important;
      }
      .pfc-collection-slider__wrapper {
        gap: 0;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: visible;
      }
      .pfc-collection-slider__track {
        gap: 8px;
        padding: 2px 4px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: auto;
        display: flex;
        flex-wrap: nowrap;
        touch-action: pan-x;
      }
      .pfc-collection-slider__track::-webkit-scrollbar {
        display: none;
      }
      .pfc-collection-card {
        width: calc(50% - 4px);
        min-width: calc(50% - 4px);
        max-width: calc(50% - 4px);
        flex-shrink: 0;
        overflow: hidden;
        box-sizing: border-box;
      }
      .pfc-collection-card__body {
        padding: 6px 6px 8px;
        box-sizing: border-box;
        width: 100%;
        overflow: hidden;
      }
      .pfc-collection-card__form {
        width: 100%;
        box-sizing: border-box;
      }
      .pfc-collection-card__btn {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 6px 8px;
        font-size: 0.65rem;
        min-height: 32px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
        word-wrap: break-word;
      }
      
      .pfc-collection-card__title {
        font-size: 0.7rem;
        min-height: 1.4em;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.3;
      }

      [data-calculator-block] {
        display: block !important;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
        overflow: visible;
      }

      .pfc-complete-set__promo-addons {
        display: block !important;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin-bottom: 12px;
        overflow: visible;
      }

      .pfc-promo-addon {
        display: flex !important;
        flex-direction: column;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 10px;
        margin-bottom: 10px;
        gap: 10px;
        overflow: visible;
      }
    }

    .sample-box {
      margin-top: 10px;
    }
    .sample-box__inner {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 14px 16px;
      border-radius: 16px;
      background: #0b1120;
      color: #e5e7eb;
      box-shadow: 0 10px 24px rgba(15,23,42,0.45);
      position: relative;
      overflow: hidden;
    }
    .sample-box__inner::after {
      content: "";
      position: absolute;
      inset: auto -30% -60%;
      height: 120px;
      background: radial-gradient(circle, rgba(56,189,248,0.25), transparent 60%);
      pointer-events: none;
    }
    .sample-box__icon {
      font-size: 28px;
      line-height: 1;
    }
    .sample-box__content {
      flex: 1;
      position: relative;
      z-index: 1;
    }
    .sample-box__label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      background: rgba(16,185,129,0.18);
      border: 1px solid rgba(45,212,191,0.45);
      color: #a7f3d0;
      margin-bottom: 4px;
    }
    .sample-box__title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .sample-box__text {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    .sample-box__form {
      margin-bottom: 6px;
    }
    .sample-box__btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      background: linear-gradient(135deg, #fb923c, #ea580c);
      color: #fff;
      box-shadow: 0 10px 18px rgba(234,88,12,0.55);
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
    }
    .sample-box__btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 24px rgba(234,88,12,0.65);
    }
    .sample-box__link {
      font-size: 12px;
      text-decoration: underline;
      text-underline-offset: 3px;
      color: #cbd5f5;
    }
    .sample-box__overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
      z-index: 60;
    }
    .sample-box__popup {
      position: fixed;
      inset: 50% auto auto 50%;
      transform: translate(-50%, -40%) scale(0.95);
      background: #020617;
      color: #e5e7eb;
      border-radius: 12px;
      padding: 14px 16px;
      max-width: 320px;
      width: calc(100% - 32px);
      box-shadow: 0 12px 28px rgba(15,23,42,0.7);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index: 70;
    }
    .sample-box__popup-inner {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .sample-box__popup-title {
      font-weight: 700;
      font-size: 15px;
    }
    .sample-box__popup-text {
      font-size: 13px;
      opacity: 0.9;
    }
    .sample-box__popup-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .sample-box__popup-close,
    .sample-box__popup-cart {
      flex: 1 1 auto;
      text-align: center;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }
    .sample-box__popup-close {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
    }
    .sample-box__popup-cart {
      background: #22c55e;
      color: #022c22;
      text-decoration: none;
    }
    .sample-box.is-visible .sample-box__overlay {
      opacity: 1;
      pointer-events: auto;
    }
    .sample-box.is-visible .sample-box__popup {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    @media (max-width: 749px) {
      .sample-box__inner {
        padding: 12px 12px;
        border-radius: 14px;
      }
      .sample-box__title {
        font-size: 14px;
      }
      .sample-box__text {
        font-size: 12px;
      }
    }
  </style>

  <script defer>
    (function() {
      const sectionId = '{{ section.id }}';
      const root = document.getElementById('pfc-' + sectionId);

      // Toast Notification System
      function showToast(message, type = 'success', duration = 3000) {
        const existingToasts = document.querySelectorAll('.pfc-toast');
        existingToasts.forEach(toast => {
          toast.classList.add('pfc-toast--hide');
          setTimeout(() => toast.remove(), 300);
        });

        const toast = document.createElement('div');
        toast.className = 'pfc-toast pfc-toast--' + type;
        
        // Икони според типа
        const icons = {
          success: '✓',
          error: '✕',
          warning: '⚠',
          info: 'ℹ'
        };
        
        toast.innerHTML = '<span class="pfc-toast__icon">' + (icons[type] || '') + '</span><span>' + message + '</span>';
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('pfc-toast--hide');
          setTimeout(() => toast.remove(), 300);
        }, duration);
        
        return toast;
      }

      // Loading State Management
      function showLoading(button) {
        if (!button) return;
        button.classList.add('pfc-btn--loading');
        button.disabled = true;
        if (!button.dataset.originalText) {
          button.dataset.originalText = button.textContent;
        }
        button.textContent = '';
      }

      function hideLoading(button) {
        if (!button) return;
        button.classList.remove('pfc-btn--loading');
        button.disabled = false;
        button.textContent = button.dataset.originalText || 'Добави в количката';
      }
      function showSuccess(button, message) {
        if (!button) return;
        const originalText = button.dataset.originalText || button.textContent;
        button.classList.add('pfc-btn--success');
        button.disabled = true;
        setTimeout(() => {
          button.classList.remove('pfc-btn--success');
          button.disabled = false;
          button.textContent = originalText;
        }, 2000);
        if (message) {
          showToast(message, 'success');
        }
      }

      // Error Handling
      function showError(message, field) {
        showToast(message, 'error', 5000);
        if (field) {
          field.classList.add('pfc-input--error');
          setTimeout(() => {
            field.classList.remove('pfc-input--error');
          }, 3000);
        }
      }
      function safeExecute(fn, errorMessage) {
        try {
          return fn();
        } catch (error) {
          console.error(errorMessage, error);
          showError(errorMessage || 'Възникна грешка. Моля, опитайте отново.');
          return null;
        }
      }

      // ===== КРАЙ НА UX ПОДОБРЕНИЯ =====
      if (!root) {
        // Опитваме се отново след малко, ако root все още не е наличен
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            const retryRoot = document.getElementById('pfc-' + sectionId);
            if (retryRoot) {
              // Може да се извика повторно инициализацията ако е необходимо
            }
          });
        }
        return;
      }

      const currencyCode = {{ shop.currency | json }};
      const thumbButtons = root.querySelectorAll('.pfc-gallery__thumb');
      const mainImage = root.querySelector('.pfc-gallery__main-img');
      const prevBtn = root.querySelector('.pfc-gallery__nav-btn--prev');
      const nextBtn = root.querySelector('.pfc-gallery__nav-btn--next');
      
      function updateActiveThumb(index) {
        if (index < 0 || index >= thumbButtons.length) return;
        if (!mainImage) return;
        
        thumbButtons.forEach((t, i) => {
          if (i === index) {
            t.classList.add('is-active');
            t.setAttribute('aria-current', 'true');
            const imageUrl = t.getAttribute('data-image');
            if (imageUrl) {
              // Update image with proper loading
              mainImage.loading = 'eager';
              // Only apply fade effect if switching between different images (not on initial page load)
              const isInitialLoad = !mainImage.complete || mainImage.naturalWidth === 0;
              const isDifferentImage = mainImage.src && mainImage.src !== imageUrl;
              if (!isInitialLoad && isDifferentImage) {
                // Only fade if switching between different images
                mainImage.style.opacity = '0.7';
              } else {
                // Keep opacity at 1 for initial load to prevent flickering
                mainImage.style.opacity = '1';
              }
              mainImage.src = imageUrl;
              // Update srcset if it exists (with WebP format for better performance)
              if (mainImage.srcset) {
                const baseUrl = imageUrl.split('?')[0];
                const formatParam = imageUrl.includes('format=') ? '' : '&format=webp';
                mainImage.srcset = baseUrl + '?width=512' + formatParam + ' 512w, ' + baseUrl + '?width=1024' + formatParam + ' 1024w, ' + baseUrl + '?width=2048' + formatParam + ' 2048w';
              }
              mainImage.onload = function() {
                mainImage.style.opacity = '1';
              };
              // Fallback in case onload doesn't fire
              setTimeout(function() {
                if (mainImage && mainImage.style.opacity !== '1') {
                  mainImage.style.opacity = '1';
                }
              }, 200);
            }
          } else {
            t.classList.remove('is-active');
            t.removeAttribute('aria-current');
          }
        });
        
        // Обновяване на състоянието на стрелките
        if (prevBtn) {
          prevBtn.disabled = index === 0;
        }
        if (nextBtn) {
          nextBtn.disabled = index === thumbButtons.length - 1;
        }
      }
      
      function getCurrentIndex() {
        let currentIndex = 0;
        thumbButtons.forEach((btn, index) => {
          if (btn.classList.contains('is-active') || btn.getAttribute('aria-current') === 'true') {
            currentIndex = index;
          }
        });
        return currentIndex;
      }
      
      // Cache thumbs container once (performance optimization)
      const thumbsContainer = root.querySelector('.pfc-gallery__thumbs');
      
      // Handle thumbnail clicks - works on both mobile and desktop
      thumbButtons.forEach((btn, index) => {
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTime = 0;
        let touchMoved = false;
        let containerScrollLeft = 0;
        let touchHandled = false;
        function handleClick(e) {
          if (touchHandled) {
            touchHandled = false;
            return;
          }
          updateActiveThumb(index);
        }
        
        // Touch start - record initial position and scroll
        btn.addEventListener('touchstart', function(e) {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          touchStartTime = Date.now();
          touchMoved = false;
          touchHandled = false;
          if (thumbsContainer) {
            containerScrollLeft = thumbsContainer.scrollLeft;
          }
        }, { passive: true });
        btn.addEventListener('touchmove', function(e) {
          if (touchStartX === 0 && touchStartY === 0) return;
          const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
          const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
          // If movement is significant (more than 10px), it's a scroll
          if (deltaX > 10 || deltaY > 10) {
            touchMoved = true;
          }
        }, { passive: true });
        
        // Touch end - trigger click if it wasn't a scroll
        btn.addEventListener('touchend', function(e) {
          const touchDuration = Date.now() - touchStartTime;
          const deltaX = Math.abs(e.changedTouches[0].clientX - touchStartX);
          const deltaY = Math.abs(e.changedTouches[0].clientY - touchStartY);
          let containerScrolled = false;
          if (thumbsContainer) {
            containerScrolled = Math.abs(thumbsContainer.scrollLeft - containerScrollLeft) > 10;
          }
          
          // If it's a quick tap with minimal movement and no container scroll, treat as click
          if (!touchMoved && !containerScrolled && touchDuration < 300 && deltaX < 10 && deltaY < 10) {
            e.preventDefault();
            e.stopPropagation();
            touchHandled = true;
            updateActiveThumb(index);
          }
          setTimeout(function() {
            touchStartX = 0;
            touchStartY = 0;
            touchStartTime = 0;
            touchMoved = false;
            containerScrollLeft = 0;
          }, 150);
        }, { passive: false });
        btn.addEventListener('click', handleClick);
      });
      
      // Навигация с стрелките
      if (prevBtn) {
        prevBtn.addEventListener('click', function() {
          let currentIndex = getCurrentIndex();
          if (currentIndex > 0) {
            updateActiveThumb(currentIndex - 1);
          }
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', function() {
          let currentIndex = getCurrentIndex();
          if (currentIndex < thumbButtons.length - 1) {
            updateActiveThumb(currentIndex + 1);
          }
        });
      }
      if (thumbButtons.length > 0) {
        const currentIndex = getCurrentIndex();
        if (prevBtn) prevBtn.disabled = currentIndex === 0;
        if (nextBtn) nextBtn.disabled = currentIndex === thumbButtons.length - 1;
        if (thumbButtons.length <= 1) {
          if (prevBtn) prevBtn.style.display = 'none';
          if (nextBtn) nextBtn.style.display = 'none';
        }
      } else {
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
      }

      // Навигация на миниатюрите (хоризонтално скролване)
      // Reuse cached thumbsContainer from above (performance optimization)
      const thumbsPrevBtn = root.querySelector('.pfc-gallery__thumbs-nav--prev');
      const thumbsNextBtn = root.querySelector('.pfc-gallery__thumbs-nav--next');
      
      function updateThumbsNavButtons() {
        if (!thumbsContainer || !thumbsPrevBtn || !thumbsNextBtn) return;
        
        const scrollLeft = thumbsContainer.scrollLeft;
        const scrollWidth = thumbsContainer.scrollWidth;
        const clientWidth = thumbsContainer.clientWidth;
        if (scrollWidth <= clientWidth) {
          thumbsPrevBtn.style.display = 'none';
          thumbsNextBtn.style.display = 'none';
          return;
        }
        
        thumbsPrevBtn.style.display = 'flex';
        thumbsNextBtn.style.display = 'flex';
        
        // Проверка за позиция на скрола
        const isAtLeft = scrollLeft <= 0;
        const isAtRight = scrollLeft + clientWidth >= scrollWidth - 5;
        
        thumbsPrevBtn.disabled = isAtLeft;
        thumbsNextBtn.disabled = isAtRight;
      }
      let scrollTimeout = null;
      function throttledUpdateThumbsNavButtons() {
        if (scrollTimeout) return;
        scrollTimeout = requestAnimationFrame(function() {
          updateThumbsNavButtons();
          scrollTimeout = null;
        });
      }
      
      // Скролване на миниатюрите
      if (thumbsPrevBtn && thumbsContainer) {
        thumbsPrevBtn.addEventListener('click', function() {
          if (thumbsContainer) {
            const scrollAmount = 100;
            thumbsContainer.scrollBy({
              left: -scrollAmount,
              behavior: 'auto'
            });
          }
        });
      }
      
      if (thumbsNextBtn && thumbsContainer) {
        thumbsNextBtn.addEventListener('click', function() {
          if (thumbsContainer) {
            const scrollAmount = 100;
            thumbsContainer.scrollBy({
              left: scrollAmount,
              behavior: 'auto'
            });
          }
        });
      }
      if (thumbsContainer) {
        thumbsContainer.addEventListener('scroll', throttledUpdateThumbsNavButtons, { passive: true });
        setTimeout(updateThumbsNavButtons, 100);
        let resizeTimeout = null;
        const resizeObserver = new ResizeObserver(() => {
          if (resizeTimeout) return;
          resizeTimeout = requestAnimationFrame(function() {
            updateThumbsNavButtons();
            resizeTimeout = null;
          });
        });
        resizeObserver.observe(thumbsContainer);
      }
      const zoomBtn = root.querySelector('.pfc-gallery__zoom-btn');
      const zoomModal = root.querySelector('#pfc-zoom-modal-' + sectionId);
      const zoomModalImg = root.querySelector('#pfc-zoom-img-' + sectionId);
      const zoomModalClose = root.querySelector('.pfc-gallery__zoom-modal-close');
      
      // Запази оригиналния overflow стил
      let originalBodyOverflow = null;
      
      function openZoom() {
        if (!zoomModal || !zoomModalImg || !mainImage) return;
        
        // Зареждане на по-голяма версия на снимката
        let imgSrc = mainImage.src;
        if (imgSrc.includes('width=')) {
          imgSrc = imgSrc.replace(/width=\d+/, 'width=2048');
        } else if (imgSrc.includes('?')) {
          imgSrc = imgSrc.replace(/\?.*$/, '') + '?width=2048';
        } else {
          imgSrc = imgSrc + '?width=2048';
        }
        
        zoomModalImg.loading = 'eager';
        zoomModalImg.src = imgSrc;
        zoomModalImg.alt = mainImage.alt || '';
        zoomModal.classList.add('is-open');
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      (window.innerWidth <= 768 && 'ontouchstart' in window);
        if (!isMobile) {
          originalBodyOverflow = document.body.style.overflow || '';
          document.body.style.overflow = 'hidden';
        }
      }
      
      function closeZoom() {
        if (!zoomModal) return;
        zoomModal.classList.remove('is-open');
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                      (window.innerWidth <= 768 && 'ontouchstart' in window);
        if (!isMobile) {
          if (originalBodyOverflow !== null) {
            document.body.style.overflow = originalBodyOverflow;
            originalBodyOverflow = null;
          } else {
            document.body.style.overflow = '';
          }
        }
        setTimeout(function() {
          var isMobileCheck = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                             (window.innerWidth <= 768 && 'ontouchstart' in window);
          if (!isMobileCheck && !zoomModal.classList.contains('is-open')) {
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
          }
        }, 100);
      }
      
      if (zoomBtn) {
        zoomBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          openZoom();
        });
      }
      
      if (zoomModalClose) {
        zoomModalClose.addEventListener('click', function(e) {
          e.stopPropagation();
          closeZoom();
        });
      }
      
      if (zoomModal) {
        zoomModal.addEventListener('click', function(e) {
          if (e.target === zoomModal) {
            closeZoom();
          }
        });
        
        // Затваряне с ESC
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && zoomModal.classList.contains('is-open')) {
            closeZoom();
          }
        });
      }
      if (mainImage && zoomModalImg) {
        let mutationTimeout = null;
        const observer = new MutationObserver(function() {
          if (mutationTimeout) return;
          mutationTimeout = requestAnimationFrame(function() {
            if (zoomModal && zoomModal.classList.contains('is-open')) {
              let imgSrc = mainImage.src;
              if (imgSrc.includes('width=')) {
                imgSrc = imgSrc.replace(/width=\d+/, 'width=2048');
              } else if (imgSrc.includes('?')) {
                imgSrc = imgSrc.replace(/\?.*$/, '') + '?width=2048';
              } else {
                imgSrc = imgSrc + '?width=2048';
              }
              zoomModalImg.loading = 'eager';
              zoomModalImg.src = imgSrc;
              zoomModalImg.alt = mainImage.alt || '';
            }
            mutationTimeout = null;
          });
        });
        observer.observe(mainImage, { attributes: true, attributeFilter: ['src', 'alt']         });
      }
      const qtyInput = root.querySelector('#pfc-qty-standard-' + sectionId);
      const qtyButtons = root.querySelectorAll('.pfc-qty-btn:not([data-target])');
      
      if (qtyInput && qtyButtons.length) {
        qtyButtons.forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const action = this.getAttribute('data-action');
            if (!action) return;
            
            let value = parseInt(qtyInput.value) || 1;
            
            if (action === 'increase') {
              value++;
            } else if (action === 'decrease' && value > 1) {
              value--;
            }
            
            qtyInput.value = value;
          });
        });
      }

      (function bindVariantIdListenerGlobal() {
        setTimeout(function() {
          const addForm = root.querySelector('form[action*="/cart/add"]');
          
          if (!addForm) {
            const idInputDirect = root.querySelector('input[name="id"]');
            if (idInputDirect) {
              const fire = () => {
                const variantId = Number(idInputDirect.value);
                if (Number.isFinite(variantId) && variantId > 0) {
                  if (typeof variantUpdateTimeout !== 'undefined') {
                    variantUpdateTimeout = null;
                  }
                  // Извикваме updateVariant ако е дефинирана
                  if (typeof updateVariant === 'function') {
                    updateVariant(variantId);
                  } else {
                    console.warn('[PFC] updateVariant not available yet, will retry');
                    setTimeout(() => {
                      if (typeof updateVariant === 'function') {
                        updateVariant(variantId);
                      }
                    }, 100);
                  }
                }
              };
              idInputDirect.addEventListener('change', fire);
              idInputDirect.addEventListener('input', fire);
              const observer = new MutationObserver(fire);
              observer.observe(idInputDirect, { attributes: true, attributeFilter: ['value'] });
              fire();
            }
            return;
          }
          
          const idInput = addForm.querySelector('input[name="id"]');

          if (!idInput) {
            console.warn('[PFC] Variant ID input not found in form');
            return;
          }

          const fire = () => {
            const variantId = Number(idInput.value);
            if (Number.isFinite(variantId) && variantId > 0) {
              if (typeof variantUpdateTimeout !== 'undefined') {
                variantUpdateTimeout = null;
              }
              if (typeof updateVariant === 'function') {
                updateVariant(variantId);
              } else {
                console.warn('[PFC] updateVariant not available yet, will retry');
                setTimeout(() => {
                  if (typeof updateVariant === 'function') {
                    updateVariant(variantId);
                  }
                }, 100);
              }
            }
          };

          idInput.addEventListener('change', fire);
          idInput.addEventListener('input', fire);
          const observer = new MutationObserver(fire);
          observer.observe(idInput, { attributes: true, attributeFilter: ['value'] });
          fire();
        }, 300);
      })();

        const qtyM2Input = root.querySelector('#pfc-qty-m2-' + sectionId);
        const qtyM2Buttons = root.querySelectorAll('.pfc-qty-btn[data-target="m2"]');
      
      let calculateCompleteSet = null;
      let debouncedCalculateCompleteSet = null;
      let wasteCheckbox = null;
      let packagesEl = null;
      let roofAreaEl = null;
      let totalEl = null;
      let totalCompareEl = null;
      let totalSavingsEl = null;
      let packagePriceEl = null;
      let hiddenQtyInput = null;
      let packageSize = parseFloat('{{ calc_package_size }}') || 2.196;
      {% assign initial_package_size = calc_package_size %}
      {% if p != blank and current_variant != blank and current_variant.metafields.custom.calculator_package_size != blank %}
        {% assign initial_package_size = current_variant.metafields.custom.calculator_package_size.value | default: current_variant.metafields.custom.calculator_package_size | plus: 0 %}
      {% endif %}
      let currentPackageSize = Number({{ initial_package_size | plus: 0 }}) || 1;
      let wastePercent = {{ calc_waste_percent }};
      let unitLabel = '{{ calc_unit_label }}';
      let packageLabel = '{{ section.settings.package_label | default: "Packages" }}';
        
        {% if p != blank and current_variant != blank %}
          let basePrice = {{ current_variant.price }};
          let baseComparePrice = {{ current_variant.compare_at_price | default: 0 }};
        {% else %}
          let basePrice = 0;
          let baseComparePrice = 0;
        {% endif %}
      
      {% if section.settings.enable_currency_conversion and section.settings.show_eur_alongside_bgn %}
        const eurRate = parseFloat('{{ section.settings.eur_to_bgn_rate | default: "1.95583" }}') || 1.95583;
      {% else %}
        const eurRate = null;
      {% endif %}

        function formatMoney(amount) {
          return new Intl.NumberFormat('bg-BG', {
            style: 'currency',
            currency: currencyCode,
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
            currencyDisplay: 'symbol'
          }).format(amount / 100);
        }
      
      function formatMoneyEur(amountEur) {
        return new Intl.NumberFormat('de-DE', {
          style: 'currency',
          currency: 'EUR',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amountEur);
      }
      
      function formatMoneyWithEurFirst(amountCents) {
        if (eurRate) {
          const eur = (amountCents / 100) / eurRate;
          return `${formatMoneyEur(eur)} / ${formatMoney(amountCents)}`;
        }
        return formatMoney(amountCents);
      }

        let calculateTimeout = null;
      
      // Намираме елементите винаги, независимо от show_complete_set
      wasteCheckbox = root.querySelector('#pfc-waste-' + sectionId) || document.querySelector('#pfc-waste-' + sectionId);
      packagesEl = root.querySelector('#pfc-packages-' + sectionId);
      roofAreaEl = root.querySelector('#pfc-roof-area-value-' + sectionId);
      totalEl = root.querySelector('#pfc-total-' + sectionId);
      totalCompareEl = root.querySelector('#pfc-total-compare-' + sectionId);
      totalSavingsEl = root.querySelector('#pfc-total-savings-' + sectionId);
      packagePriceEl = root.querySelector('#pfc-package-price-' + sectionId);
      hiddenQtyInput = root.querySelector('#pfc-qty-complete-' + sectionId);
      
      // Helper функция за обновяване на package size и UI
      function setPackageSizeAndRefreshUI(size, matchingVariant) {
        if (!matchingVariant) {
          return;
        }
        
        // Prefer unit_price_measurement.quantity_value if available
        if (matchingVariant.unit_price_measurement && matchingVariant.unit_price_measurement.quantity_value > 0) {
          currentPackageSize = parseFloat(matchingVariant.unit_price_measurement.quantity_value);
          packageSize = currentPackageSize;
        } else if (size !== null && size !== undefined && size !== '') {
          // Fallback to metafield/setting
          const normalized = parseFloat(String(size).replace(',', '.'));
          // Обновяване само ако normalized е валиден (не NaN и > 0)
          if (!isNaN(normalized) && normalized > 0) {
            currentPackageSize = normalized;
            packageSize = currentPackageSize;
          }
        }
        // Ако size не е валиден, запазваме текущата стойност
        packageSize = currentPackageSize;
        
        // ВИНАГИ обновяваме UI елементите
        // Обновяване на #pfc-package-size-...
        const packageSizeEl = root.querySelector('#pfc-package-size-' + sectionId) || document.querySelector('#pfc-package-size-' + sectionId);
        if (packageSizeEl) {
          const sizeText = currentPackageSize.toFixed(3).replace('.', ',');
          packageSizeEl.textContent = sizeText;
        } else {
        }
        
        // Обновяване на package content (винаги, дори ако е празно/null)
        const packageContentEl = root.querySelector('#pfc-package-content-' + sectionId) || document.querySelector('#pfc-package-content-' + sectionId);
        if (packageContentEl) {
          let contentText = '';
          if (matchingVariant.package_content) {
            const contentStr = String(matchingVariant.package_content);
            if (contentStr.trim() !== '' && contentStr !== 'null' && contentStr !== 'undefined') {
              contentText = contentStr.trim() + ' | ';
            }
          }
          packageContentEl.textContent = contentText;
        } else {
        }
        
        // Обновяване на #pfc-package-price-...
        if (matchingVariant && packagePriceEl && matchingVariant.price > 0) {
          const packagePrice = matchingVariant.price;
          packagePriceEl.innerHTML = formatMoneyWithEurFirst(packagePrice);
        }
        
        // Обновяване на #pfc-packages-... на база текущото qty m2
        if (qtyM2Input && packagesEl) {
          let qtyM2 = parseFloat(qtyM2Input.value);
          if (isNaN(qtyM2) || qtyM2 <= 0) {
            qtyM2 = {{ calc_default_quantity }};
          }
          const packages = Math.ceil(qtyM2 / currentPackageSize);
          packagesEl.innerHTML = '<span>' + packages + ' ' + packageLabel + '</span>';
          
          // Обновяване на покривната площ
          if (roofAreaEl) {
            const realM2 = packages * currentPackageSize;
            roofAreaEl.textContent = realM2.toFixed(2).replace('.', ',');
          }
        }
        
        // ВИНАГИ извиквай calculateCompleteSet() за синхронизация на total/compare/savings
        if (typeof calculateCompleteSet === 'function') {
          calculateCompleteSet();
        }
      }
      
      calculateCompleteSet = function() {
          if (!qtyM2Input) return;
          
          let qtyM2 = parseFloat(qtyM2Input.value);
          if (isNaN(qtyM2) || qtyM2 <= 0) {
            qtyM2 = {{ calc_default_quantity }};
            qtyM2Input.value = qtyM2;
          }
          
          const currentWasteCheckbox = root.querySelector('#pfc-waste-' + sectionId) || document.querySelector('#pfc-waste-' + sectionId);
          let currentWastePercent = wastePercent || 5;
          if (currentWasteCheckbox) {
            if (currentWasteCheckbox.hasAttribute('data-waste-percent')) {
              const dataWastePercentAttr = currentWasteCheckbox.getAttribute('data-waste-percent');
              const dataWastePercent = parseFloat(dataWastePercentAttr);
              if (!isNaN(dataWastePercent) && dataWastePercent > 0) {
                currentWastePercent = dataWastePercent;
              }
            }
            if (currentWasteCheckbox.checked) {
              qtyM2 = qtyM2 * (1 + currentWastePercent / 100);
            }
          }
          
          const packages = Math.ceil(qtyM2 / currentPackageSize);
          if (packagesEl) {
            packagesEl.innerHTML = '<span>' + packages + ' ' + packageLabel + '</span>';
          }
          const realM2 = packages * currentPackageSize;
          if (roofAreaEl) {
            roofAreaEl.textContent = realM2.toFixed(2).replace('.', ',');
          }
          
          if (packagePriceEl && basePrice > 0) {
            // Промяна: basePrice вече е цена на пакет, не умножаваме по packageSize
            const packagePrice = basePrice;
            packagePriceEl.innerHTML = formatMoneyWithEurFirst(packagePrice);
          }
          
          if (basePrice > 0) {
            const totalPrice = Math.round(basePrice * packages);
            const totalComparePrice = baseComparePrice > 0 ? Math.round(baseComparePrice * packages) : 0;
            const savings = totalComparePrice > 0 ? totalComparePrice - totalPrice : 0;
            const totalElCurrent = root.querySelector('#pfc-total-' + sectionId);
          if (totalElCurrent) {
            totalElCurrent.innerHTML = formatMoneyWithEurFirst(totalPrice);
          }
          
          const totalCompareElCurrent = root.querySelector('#pfc-total-compare-' + sectionId);
          if (totalCompareElCurrent && totalComparePrice > 0) {
            totalCompareElCurrent.innerHTML = formatMoneyWithEurFirst(totalComparePrice);
            totalCompareElCurrent.style.display = 'inline';
          } else if (totalCompareElCurrent) {
            totalCompareElCurrent.style.display = 'none';
          }
          
          const totalSavingsElCurrent = root.querySelector('#pfc-total-savings-' + sectionId);
          if (totalSavingsElCurrent && savings > 0) {
            totalSavingsElCurrent.textContent = formatMoney(savings) + ' {{ section.settings.saved_label | default: "saved" }}';
            totalSavingsElCurrent.style.display = 'block';
          } else if (totalSavingsElCurrent) {
            totalSavingsElCurrent.style.display = 'none';
            }
            
            if (hiddenQtyInput) {
              hiddenQtyInput.value = parseFloat(realM2.toFixed(2));
            }
          } else {
          if (hiddenQtyInput) {
            hiddenQtyInput.value = parseFloat(realM2.toFixed(2));
          }
          }
      };
        
      debouncedCalculateCompleteSet = function() {
          if (calculateTimeout) clearTimeout(calculateTimeout);
          calculateTimeout = setTimeout(function() {
            calculateCompleteSet();
            calculateTimeout = null;
          }, 150);
        }

      // Контроли за количество m² - винаги активни
        if (qtyM2Input && qtyM2Buttons.length) {
          qtyM2Buttons.forEach(btn => {
            btn.addEventListener('click', function() {
              const action = this.getAttribute('data-action');
                const step = {{ calc_quantity_step }};
                let value = parseFloat(qtyM2Input.value) || {{ calc_default_quantity }};
                
                if (action === 'increase') {
                  value += step;
                } else if (action === 'decrease') {
                  const min = {{ calc_min_quantity }};
                value = Math.max(min, value - step);
              }
              
              qtyM2Input.value = value;
              calculateCompleteSet();
            });
          });
          
          qtyM2Input.addEventListener('input', debouncedCalculateCompleteSet);
          qtyM2Input.addEventListener('change', calculateCompleteSet);
        
        if (typeof calculateCompleteSet === 'function') {
          calculateCompleteSet();
        }
        }

      const wasteCheckboxForListener = root.querySelector('#pfc-waste-' + sectionId) || document.querySelector('#pfc-waste-' + sectionId);
      if (wasteCheckboxForListener) {
        wasteCheckboxForListener.addEventListener('change', function(e) {
          e.stopPropagation();
          if (typeof calculateCompleteSet === 'function') {
            calculateCompleteSet();
          }
        });
      }

      // Първоначално изчисление
      if (qtyM2Input && typeof calculateCompleteSet === 'function') {
        setTimeout(function() {
          calculateCompleteSet();
        }, 100);
      }

      {% if p != blank and p.variants.size > 1 %}
        const variantSelects = root.querySelectorAll('.pfc-variant-select');
        const priceElement = root.querySelector('#pfc-price-' + sectionId);
        const priceCompareElement = root.querySelector('#pfc-price-compare-' + sectionId);
        const stockBadge = root.querySelector('#pfc-stock-' + sectionId);
        const addToCartBtnStandard = root.querySelector('#pfc-add-to-cart-standard-' + sectionId);
        const addToCartBtnComplete = root.querySelector('#pfc-add-to-cart-complete-' + sectionId);
        
        const productData = {
          variants: [
            {% for variant in p.variants %}
              {
                id: {{ variant.id }},
                price: {{ variant.price }},
                compare_at_price: {{ variant.compare_at_price | default: 0 }},
                unit_price: {{ variant.unit_price | default: 0 }},
                unit_price_measurement: {% if variant.unit_price_measurement != blank %}{quantity_value: {{ variant.unit_price_measurement.quantity_value | default: 0 }}, reference_unit: {{ variant.unit_price_measurement.reference_unit | json }}}{% else %}null{% endif %},
                available: {{ variant.available | json }},
                option1: {{ variant.option1 | json }},
                option2: {{ variant.option2 | json }},
                option3: {{ variant.option3 | json }},
                image: {% if variant.featured_image %}{{ variant.featured_image | image_url: width: 1024 | json }}{% else %}null{% endif %},
                package_size: {% if variant.metafields.custom.calculator_package_size != blank %}{{ variant.metafields.custom.calculator_package_size.value | default: variant.metafields.custom.calculator_package_size | plus: 0 }}{% elsif p.metafields.custom.calculator_package_size != blank %}{{ p.metafields.custom.calculator_package_size.value | default: p.metafields.custom.calculator_package_size | plus: 0 }}{% elsif section.settings.package_size != blank %}{{ section.settings.package_size | plus: 0 }}{% else %}{{ calc_package_size | plus: 0 }}{% endif %},
                package_content: {% if variant.metafields.custom.calculator_package_content != blank %}{{ variant.metafields.custom.calculator_package_content.value | default: variant.metafields.custom.calculator_package_content | json }}{% elsif p.metafields.custom.calculator_package_content != blank %}{{ p.metafields.custom.calculator_package_content.value | default: p.metafields.custom.calculator_package_content | json }}{% else %}""{% endif %}
              }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ]
        };

        let variantUpdateTimeout = null;
        
        function getSelectedOptions(root) {
          const selectedOptions = ['', '', ''];
          const selects = root.querySelectorAll('.pfc-variant-select');
          selects.forEach(select => {
            const optionIndex = select.getAttribute('data-option-index');
            if (optionIndex !== null && select.value) {
              const idx = parseInt(optionIndex) - 1;
              if (idx >= 0 && idx < 3) {
                selectedOptions[idx] = select.value;
              }
            }
          });
          const radioFieldsets = root.querySelectorAll('fieldset[data-option-index]');
          radioFieldsets.forEach(fieldset => {
            const optionIndex = fieldset.getAttribute('data-option-index');
            const checkedRadio = fieldset.querySelector('input[type="radio"]:checked');
            if (optionIndex !== null && checkedRadio && checkedRadio.value) {
              const idx = parseInt(optionIndex) - 1;
              if (idx >= 0 && idx < 3) {
                selectedOptions[idx] = checkedRadio.value;
              }
            }
          });
          if (selectedOptions.every(v => v === '')) {
            const allCheckedRadios = root.querySelectorAll('input[type="radio"]:checked');
            allCheckedRadios.forEach((radio, idx) => {
              if (radio.value && idx < 3) {
                selectedOptions[idx] = radio.value;
              }
            });
          }
          
          return selectedOptions;
        }
        
        function updateVariant(initialVariantId) {
          if (variantUpdateTimeout) {
            return;
          }
          variantUpdateTimeout = requestAnimationFrame(function() {
            try {
              let matchingVariant = null;
              let currentVariantId = null;
              if (initialVariantId) {
                currentVariantId = parseInt(initialVariantId);
                  matchingVariant = productData.variants.find(v => v.id === Number(currentVariantId));
              } else {
                const pfcVariantInput = root.querySelector('input[name="id"][id^="pfc-variant-id-"]');
                const dawnVariantInput = root.querySelector('form[action*="/cart/add"] input[name="id"]');
                const variantInput = pfcVariantInput || dawnVariantInput;
                
                if (variantInput && variantInput.value) {
                  currentVariantId = Number(variantInput.value);
                  matchingVariant = productData.variants.find(v => v.id === currentVariantId);
                }
              }
              if (!matchingVariant) {
                const selectedOptions = getSelectedOptions(root);
                matchingVariant = productData.variants.find(v => {
                  return (
                    (v.option1 === selectedOptions[0] || !selectedOptions[0]) &&
                    (v.option2 === selectedOptions[1] || !selectedOptions[1]) &&
                    (v.option3 === selectedOptions[2] || !selectedOptions[2])
                  );
                });
              }
            if (matchingVariant) {
            const variantIdInputs = root.querySelectorAll('input[name="id"][id^="pfc-variant-id-"]');
            variantIdInputs.forEach(input => {
              input.value = matchingVariant.id;
            });
            
            // Актуализиране на показването на цената
            if (priceElement) {
              // Primary: Unit price per m², Secondary: Package price
              let priceHtml;
              if (matchingVariant.unit_price && matchingVariant.unit_price > 0) {
                priceHtml = formatMoneyWithEurFirst(matchingVariant.unit_price) + '/{{ section.settings.unit_label | default: "m²" }}';
                {% unless section.settings.hide_package_price_top %}
                  priceHtml += '<br><small>' + formatMoneyWithEurFirst(matchingVariant.price) + '/пакет</small>';
                {% endunless %}
              } else {
                // Fallback: show package price
                priceHtml = formatMoneyWithEurFirst(matchingVariant.price);
                {% if section.settings.show_price_per_unit %}
                  priceHtml += '/пакет';
                {% endif %}
              }
              
              if (matchingVariant.compare_at_price > matchingVariant.price) {
                let comparePriceHtml;
                if (matchingVariant.unit_price && matchingVariant.unit_price > 0 && matchingVariant.unit_price_measurement && matchingVariant.unit_price_measurement.quantity_value > 0) {
                  // Calculate compare unit price from compare_at_price
                  const compareUnitPrice = (matchingVariant.compare_at_price / 100) / matchingVariant.unit_price_measurement.quantity_value;
                  if (eurRate) {
                    const compareUnitPriceEur = compareUnitPrice / eurRate;
                    comparePriceHtml = formatMoneyEur(compareUnitPriceEur) + ' / ' + compareUnitPrice.toFixed(2).replace('.', ',') + ' лв/{{ section.settings.unit_label | default: "m²" }}';
                  } else {
                    comparePriceHtml = compareUnitPrice.toFixed(2).replace('.', ',') + ' лв/{{ section.settings.unit_label | default: "m²" }}';
                  }
                  {% unless section.settings.hide_package_price_top %}
                    comparePriceHtml += '<br><small>' + formatMoneyWithEurFirst(matchingVariant.compare_at_price) + '/пакет</small>';
                  {% endunless %}
                } else {
                  comparePriceHtml = formatMoneyWithEurFirst(matchingVariant.compare_at_price);
                  {% if section.settings.show_price_per_unit %}
                    comparePriceHtml += '/пакет';
                  {% endif %}
                }
                if (priceCompareElement) {
                  priceCompareElement.innerHTML = comparePriceHtml;
                  priceCompareElement.style.display = 'inline';
                } else {
                  priceElement.outerHTML = '<div class="pfc-price-wrapper"><div class="pfc-price-compare" id="pfc-price-compare-' + sectionId + '">' + comparePriceHtml + '</div><div class="pfc-price" id="pfc-price-' + sectionId + '">' + priceHtml + '</div></div>';
                }
              } else {
                if (priceCompareElement) {
                  priceCompareElement.style.display = 'none';
                }
                priceElement.innerHTML = priceHtml;
              }
            }
            if (stockBadge) {
              const stockClass = matchingVariant.available ? 'pfc-stock-badge--in-stock' : 'pfc-stock-badge--out-of-stock';
              const stockText = matchingVariant.available 
                ? '{{ section.settings.in_stock_label | default: "In stock" }}'
                : '{{ section.settings.out_of_stock_label | default: "Out of stock" }}';
              stockBadge.innerHTML = '<span class="' + stockClass + '">' + stockText + '</span>';
            }
            [addToCartBtnStandard, addToCartBtnComplete].forEach(btn => {
              if (btn) {
                btn.disabled = !matchingVariant.available;
                btn.textContent = matchingVariant.available 
                  ? '{{ section.settings.cta_label | default: "Add to cart" }}'
                  : '{{ section.settings.sold_out_label | default: "Sold out" }}';
              }
            });

            // Актуализиране на главната снимка, ако вариантът има снимка
            if (matchingVariant.image && mainImage) {
              mainImage.loading = 'eager';
              mainImage.src = matchingVariant.image;
            }
            basePrice = matchingVariant.price;
                baseComparePrice = matchingVariant.compare_at_price || 0;
                
            // Актуализиране на packageSize от варианта (винаги извиква helper-а за да се обновят package_content и totals)
            // Извикваме винаги, дори ако package_size е 0 или празен
            setPackageSizeAndRefreshUI(matchingVariant.package_size, matchingVariant);
                
            // Актуализиране на изчисленията за пълен комплект, ако е активирано
            {% if section.settings.show_complete_set %}
              if (typeof calculateCompleteSet === 'function') {
                const setPriceEl = root.querySelector('#pfc-set-price-' + sectionId);
                const setPriceCompareEl = root.querySelector('#pfc-set-price-compare-' + sectionId);
                
                if (setPriceEl) {
                  let setPriceHtml;
                  const unitLabel = '{{ section.settings.unit_label | default: "m²" }}';
                  // Use variant.unit_price if available, otherwise calculate from price
                  if (matchingVariant.unit_price && matchingVariant.unit_price > 0) {
                    if (eurRate) {
                      const unitPriceEur = (matchingVariant.unit_price / 100) / eurRate;
                      const unitPriceBgn = matchingVariant.unit_price / 100;
                      setPriceHtml = formatMoneyEur(unitPriceEur) + '/' + unitLabel + '-' + unitPriceBgn.toFixed(2).replace('.', ',') + ' лв/' + unitLabel;
                    } else {
                      const unitPriceBgn = matchingVariant.unit_price / 100;
                      setPriceHtml = unitPriceBgn.toFixed(2).replace('.', ',') + ' лв/' + unitLabel;
                    }
                  } else if (currentPackageSize > 0) {
                    // Fallback: calculate from price / package size
                    const pricePerM2 = (matchingVariant.price / 100) / currentPackageSize;
                    if (eurRate) {
                      const setPriceEur = pricePerM2 / eurRate;
                      setPriceHtml = formatMoneyEur(setPriceEur) + '/' + unitLabel + '-' + pricePerM2.toFixed(2).replace('.', ',') + ' лв/' + unitLabel;
                    } else {
                      setPriceHtml = pricePerM2.toFixed(2).replace('.', ',') + ' лв/' + unitLabel;
                    }
                  } else {
                    setPriceHtml = formatMoneyWithEurFirst(matchingVariant.price);
                  }
                  setPriceHtml += '<br><small>Цена на пакет: ' + formatMoneyWithEurFirst(matchingVariant.price) + '</small>';
                  setPriceEl.innerHTML = setPriceHtml;
                }
                
                if (setPriceCompareEl && matchingVariant.compare_at_price > matchingVariant.price) {
                  let setComparePriceHtml;
                  const unitLabel = '{{ section.settings.unit_label | default: "m²" }}';
                  // Calculate compare unit price from compare_at_price / unit quantity
                  if (matchingVariant.unit_price_measurement && matchingVariant.unit_price_measurement.quantity_value > 0 && currentPackageSize > 0) {
                    const compareUnitPrice = (matchingVariant.compare_at_price / 100) / matchingVariant.unit_price_measurement.quantity_value;
                    if (eurRate) {
                      const setComparePriceEur = compareUnitPrice / eurRate;
                      setComparePriceHtml = formatMoneyEur(setComparePriceEur) + '/' + unitLabel + '-' + compareUnitPrice.toFixed(2).replace('.', ',') + ' лв/' + unitLabel;
                    } else {
                      setComparePriceHtml = compareUnitPrice.toFixed(2).replace('.', ',') + ' лв/' + unitLabel;
                    }
                  } else if (currentPackageSize > 0) {
                    const comparePricePerM2 = (matchingVariant.compare_at_price / 100) / currentPackageSize;
                    if (eurRate) {
                      const setComparePriceEur = comparePricePerM2 / eurRate;
                      setComparePriceHtml = formatMoneyEur(setComparePriceEur) + '/' + unitLabel + '-' + comparePricePerM2.toFixed(2).replace('.', ',') + ' лв/' + unitLabel;
                    } else {
                      setComparePriceHtml = comparePricePerM2.toFixed(2).replace('.', ',') + ' лв/' + unitLabel;
                    }
                  } else {
                    setComparePriceHtml = formatMoneyWithEurFirst(matchingVariant.compare_at_price);
                  }
                  setPriceCompareEl.innerHTML = setComparePriceHtml;
                  setPriceCompareEl.style.display = 'inline';
                } else if (setPriceCompareEl) {
                  setPriceCompareEl.style.display = 'none';
                }
                
                calculateCompleteSet();
              }
            {% else %}
              if (typeof calculateCompleteSet === 'function') {
                calculateCompleteSet();
              }
            {% endif %}
            }
            } finally {
              variantUpdateTimeout = null;
            }
          });
        }

        // Listener за select елементи
        variantSelects.forEach(select => {
          select.addEventListener('change', function() {
            updateVariant();
          });
        });
        
        // Listener за radio inputs (за Dawn variant-radios)
        const radioInputs = root.querySelectorAll('input[type="radio"]');
        radioInputs.forEach(radio => {
          radio.addEventListener('change', function() {
            updateVariant();
          });
        });
        const pfcVariantInputs = root.querySelectorAll('input[name="id"][id^="pfc-variant-id-"]');
        const dawnVariantInputs = root.querySelectorAll('form[action*="/cart/add"] input[name="id"]');
        const allVariantInputs = Array.from(new Set([...pfcVariantInputs, ...dawnVariantInputs]));
        
        allVariantInputs.forEach(input => {
          input.addEventListener('change', function() {
            if (this.value) {
              variantUpdateTimeout = null; // Изчистваме timeout преди извикване
              updateVariant(Number(this.value));
            }
          });
          input.addEventListener('input', function() {
            if (this.value) {
              variantUpdateTimeout = null; // Изчистваме timeout преди извикване
              updateVariant(Number(this.value));
            }
          });
        });
        
        // MutationObserver за скрити промени в hidden input value (от други скриптове)
        allVariantInputs.forEach(input => {
          let lastValue = input.value;
          const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                const newValue = input.value;
                if (newValue && newValue !== lastValue) {
                  lastValue = newValue;
                  updateVariant(parseInt(newValue));
                }
              }
            });
          });
          observer.observe(input, { attributes: true, attributeFilter: ['value'] });
          setInterval(function() {
            const currentValue = input.value;
            if (currentValue && currentValue !== lastValue) {
              lastValue = currentValue;
              updateVariant(parseInt(currentValue));
            }
          }, 150);
        });
        
        // ===============================
        // PFC – Variant ID listener (Dawn-safe)
        // ===============================
        (function bindVariantIdListener() {
          const addForm = root.querySelector('form[action*="/cart/add"]');
          
          if (!addForm) {
            // Опитваме се да намерим input директно в root
            const idInputDirect = root.querySelector('input[name="id"]');
            if (idInputDirect) {
              const fire = () => {
                const variantId = Number(idInputDirect.value);
                if (Number.isFinite(variantId) && variantId > 0) {
                  variantUpdateTimeout = null;
                  updateVariant(variantId);
                }
              };
              idInputDirect.addEventListener('change', fire);
              idInputDirect.addEventListener('input', fire);
              const observer = new MutationObserver(fire);
              observer.observe(idInputDirect, { attributes: true, attributeFilter: ['value'] });
              fire();
              return;
            }
            console.warn('[PFC] Variant ID input not found - no form and no direct input');
            return;
          }
          
          const idInput = addForm.querySelector('input[name="id"]');

          if (!idInput) {
            console.warn('[PFC] Variant ID input not found in form');
            return;
          }

          const fire = () => {
            const variantId = Number(idInput.value);
            if (Number.isFinite(variantId) && variantId > 0) {
              variantUpdateTimeout = null; // Изчистваме timeout преди извикване
              updateVariant(variantId);
            }
          };

          idInput.addEventListener('change', fire);
          idInput.addEventListener('input', fire);
          const observer = new MutationObserver(fire);
          observer.observe(idInput, { attributes: true, attributeFilter: ['value'] });
          fire();
        })();
      {% endif %}
        function initializeVariantPackageSize() {
          if (!productData || !productData.variants || productData.variants.length === 0) {
            return;
          }
          const pfcInput = root.querySelector('input[name="id"][id^="pfc-variant-id-"]');
          const dawnInput = root.querySelector('form[action*="/cart/add"] input[name="id"]');
          const initialVariantInput = pfcInput || dawnInput;
          
          if (initialVariantInput && initialVariantInput.value) {
            const variantId = Number(initialVariantInput.value);
            if (variantId && !isNaN(variantId)) {
              variantUpdateTimeout = null;
              updateVariant(variantId);
            }
          }
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeVariantPackageSize, 50);
          });
        } else {
          setTimeout(initializeVariantPackageSize, 50);
        }

      const accordionItems = root.querySelectorAll('.pfc-accordion__item');
      accordionItems.forEach(item => {
        const header = item.querySelector('.pfc-accordion__header');
        if (header) {
          header.addEventListener('click', function() {
            const isOpen = item.classList.contains('is-open');
            item.classList.toggle('is-open');
            header.setAttribute('aria-expanded', !isOpen);
          });
        }
      });
      document.querySelectorAll('#pfc-' + sectionId + ' [data-collection-slider]').forEach(function(slider) {
        const track = slider.querySelector('[data-collection-track]');
        const btnPrev = slider.querySelector('[data-collection-prev]');
        const btnNext = slider.querySelector('[data-collection-next]');
        if (!track || !btnPrev || !btnNext) return;

        const scrollAmount = 260;
        var isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        btnPrev.addEventListener('click', function() {
          track.scrollBy({ left: -scrollAmount, behavior: isMobileDevice ? 'auto' : 'smooth' });
        });
        btnNext.addEventListener('click', function() {
          track.scrollBy({ left: scrollAmount, behavior: isMobileDevice ? 'auto' : 'smooth' });
        });
      });
      document.querySelectorAll('#pfc-' + sectionId + ' .pfc-collection-card__qty-controls').forEach(function(controls) {
        const decreaseBtn = controls.querySelector('[data-action="decrease"]');
        const increaseBtn = controls.querySelector('[data-action="increase"]');
        const qtyInput = controls.querySelector('.pfc-collection-card__qty-input');
        
        if (!decreaseBtn || !increaseBtn || !qtyInput) return;

        function updateQuantity(action) {
          let currentValue = parseInt(qtyInput.value, 10) || 1;
          const min = parseInt(qtyInput.getAttribute('min'), 10) || 1;
          
          if (action === 'increase') {
            currentValue += 1;
          } else if (action === 'decrease') {
            currentValue = Math.max(min, currentValue - 1);
          }
          
          qtyInput.value = currentValue;
          
          // Trigger input event for any listeners
          qtyInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        decreaseBtn.addEventListener('click', function(e) {
          e.preventDefault();
          updateQuantity('decrease');
        });

        increaseBtn.addEventListener('click', function(e) {
          e.preventDefault();
          updateQuantity('increase');
        });

        // Validate input on blur
        qtyInput.addEventListener('blur', function() {
          let value = parseInt(this.value, 10) || 1;
          const min = parseInt(this.getAttribute('min'), 10) || 1;
          value = Math.max(min, value);
          this.value = value;
        });

        // Prevent invalid input
        qtyInput.addEventListener('input', function() {
          let value = parseInt(this.value, 10);
          const min = parseInt(this.getAttribute('min'), 10) || 1;
          
          if (isNaN(value) || value < min) {
            this.value = min;
          }
        });
      });
      document.querySelectorAll('#pfc-' + sectionId + ' .pfc-promo-addon__qty-controls').forEach(function(controls) {
        const decreaseBtn = controls.querySelector('[data-action="decrease"]');
        const increaseBtn = controls.querySelector('[data-action="increase"]');
        const qtyInput = controls.querySelector('.pfc-promo-addon__qty-input');
        
        if (!decreaseBtn || !increaseBtn || !qtyInput) return;

        function updateQuantity(action) {
          let currentValue = parseInt(qtyInput.value, 10) || 1;
          const min = parseInt(qtyInput.getAttribute('min'), 10) || 1;
          
          if (action === 'increase') {
            currentValue += 1;
          } else if (action === 'decrease') {
            currentValue = Math.max(min, currentValue - 1);
          }
          
          qtyInput.value = currentValue;
          
          // Trigger input event for any listeners
          qtyInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        decreaseBtn.addEventListener('click', function(e) {
          e.preventDefault();
          updateQuantity('decrease');
        });

        increaseBtn.addEventListener('click', function(e) {
          e.preventDefault();
          updateQuantity('increase');
        });

        // Validate input on blur
        qtyInput.addEventListener('blur', function() {
          let value = parseInt(this.value, 10) || 1;
          const min = parseInt(this.getAttribute('min'), 10) || 1;
          value = Math.max(min, value);
          this.value = value;
        });

        // Prevent invalid input
        qtyInput.addEventListener('input', function() {
          let value = parseInt(this.value, 10);
          const min = parseInt(this.getAttribute('min'), 10) || 1;
          
          if (isNaN(value) || value < min) {
            this.value = min;
          }
        });
      });
      document.querySelectorAll('#pfc-' + sectionId + ' .pfc-promo-addon__form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          const submitBtn = form.querySelector('button[type="submit"]');
          if (!submitBtn) return;
          
          showLoading(submitBtn);
          
          fetch('{{ routes.cart_add_url }}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
              return response.json().then(data => {
                return { data, ok: response.ok, status: response.status };
              }).catch(() => {
                return { ok: false, error: 'Failed to parse response' };
              });
            } else {
              return response.text().then(html => {
                return { html, ok: response.ok, status: response.status };
              }).catch(() => {
                return { ok: false, error: 'Failed to read response' };
              });
            }
          })
          .then(result => {
            const { data, html, ok, status } = result;
            
            // Check if successful - Shopify returns 200/201 for success
            // Also check for common success indicators
            let isSuccess = false;
            
            if (ok && (status === 200 || status === 201)) {
              isSuccess = true;
            } else if (data) {
              isSuccess = data.status === 'success' || 
                         data.status === 200 || 
                         data.status === 201 ||
                         data.items !== undefined ||
                         (data.status === undefined && !data.error && !data.message && !data.description);
            } else if (html) {
              // For HTML responses, if status is OK, consider it success
              isSuccess = ok && !html.toLowerCase().includes('error');
            }
            
            if (isSuccess) {
              showSuccess(submitBtn, 'Продуктът е добавен в количката!');
              if (typeof window.dispatchEvent !== 'undefined') {
                document.dispatchEvent(new CustomEvent('cart:updated'));
              }
              
              const shopifyTheme = window.Shopify?.theme;
              if (shopifyTheme?.cartDrawer?.open) shopifyTheme.cartDrawer.open();
              if (shopifyTheme?.cart?.update) shopifyTheme.cart.update();
            } else {
              const errorMsg = (data && (data.error || data.message || data.description)) || 
                              (html ? 'Server returned an error' : 'Failed to add to cart');
              throw new Error(errorMsg);
            }
          })
          .catch(error => {
            hideLoading(submitBtn);
            showError('Грешка при добавяне в кошницата. Моля, опитайте отново.');
          });
        });
      });
      document.querySelectorAll('#pfc-' + sectionId + ' .pfc-collection-card__form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(form);
          const submitBtn = form.querySelector('button[type="submit"]');
          
          if (!submitBtn) return;
          
          showLoading(submitBtn);
          
          fetch('{{ routes.cart_add_url }}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              return response.json().then(data => ({ ok: response.ok, data: data }));
            } else {
              // Ако не е JSON, проверяваме дали е успешен отговор
              return response.text().then(text => ({ ok: response.ok, data: { html: text } }));
            }
          })
          .then(result => {
            const { ok, data } = result;
            
            // Проверка за успех - Shopify може да върне различни формати
            const isSuccess = ok && (
              data.status === 'success' || 
              data.status === 200 || 
              data.items || 
              (data.status === undefined && !data.error && !data.message) ||
              (data.html && !data.html.includes('error'))
            );
            
            if (isSuccess) {
              showSuccess(submitBtn, 'Продуктът е добавен в количката!');
              if (typeof window.dispatchEvent !== 'undefined') {
                document.dispatchEvent(new CustomEvent('cart:updated'));
              }
              if (window.Shopify && window.Shopify.theme) {
                const shopifyTheme = window.Shopify?.theme;
                if (shopifyTheme?.cartDrawer?.open) shopifyTheme.cartDrawer.open();
                else if (shopifyTheme?.cart?.update) shopifyTheme.cart.update();
              }
            } else {
              const errorMsg = data.error || data.message || data.description || 'Failed to add to cart';
              throw new Error(errorMsg);
            }
          })
          .catch(error => {
            hideLoading(submitBtn);
            showError('Грешка при добавяне в кошницата. Моля, опитайте отново.');
          });
          });
        });
      const completeSetForm = root.querySelector('.pfc-form-complete-set');
      const addToCartBtnComplete = root.querySelector('#pfc-add-to-cart-complete-' + sectionId);
      
      if (completeSetForm && addToCartBtnComplete) {
        function updateQuantityForCart() {
          const qtyM2Input = root.querySelector('#pfc-qty-m2-' + sectionId);
          let finalQty = null;
          
          if (qtyM2Input) {
            let qtyM2 = parseFloat(qtyM2Input.value) || {{ calc_default_quantity }};
            const wasteCheckbox = root.querySelector('#pfc-waste-' + sectionId) || document.querySelector('#pfc-waste-' + sectionId);
            let currentWastePercent = wastePercent || 5;
            if (wasteCheckbox) {
              if (wasteCheckbox.hasAttribute('data-waste-percent')) {
                const dataWastePercent = parseFloat(wasteCheckbox.getAttribute('data-waste-percent'));
                if (!isNaN(dataWastePercent) && dataWastePercent > 0) {
                  currentWastePercent = dataWastePercent;
                }
              }
              if (wasteCheckbox.checked) {
                qtyM2 = qtyM2 * (1 + currentWastePercent / 100);
              }
            }
            
            const packages = Math.ceil(qtyM2 / currentPackageSize);
            finalQty = Math.max(1, packages);
            const qtyInput = completeSetForm.querySelector('input[name="quantity"][id*="pfc-qty-complete"]');
            if (qtyInput) {
              qtyInput.setAttribute('value', finalQty.toString());
              qtyInput.value = finalQty.toString();
            }
          }
          
          return finalQty;
        }
        
        // Обработчик на клик на бутона - актуализира количеството преди submit
        addToCartBtnComplete.addEventListener('click', function(e) {
          updateQuantityForCart();
        }, { capture: true, once: false });
        
        // Обработчик на submit на формата
        completeSetForm.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const finalQty = updateQuantityForCart();
          const qtyInput = this.querySelector('input[name="quantity"][id*="pfc-qty-complete"]');
          if (qtyInput && finalQty !== null) {
            qtyInput.setAttribute('value', finalQty.toString());
            qtyInput.value = finalQty.toString();
          }
          const formData = new FormData(this);
          if (finalQty !== null) {
            formData.set('quantity', finalQty.toString());
          }
          const submitBtn = this.querySelector('button[type="submit"]');
          if (!submitBtn) return;
          showLoading(submitBtn);
          fetch('{{ routes.cart_add_url }}.js', {
            method: 'POST',
            body: formData,
            headers: {
              'Accept': 'application/json'
            }
          })
          .then(response => {
            return response.json().then(data => {
              if (response.ok && !data.error) {
                showSuccess(submitBtn, 'Продуктът е добавен в количката!');
                
                if (typeof document.dispatchEvent !== 'undefined') {
                  document.dispatchEvent(new CustomEvent('cart:updated'));
                }
                
                if (window.Shopify?.theme?.cartDrawer?.open) {
                  window.Shopify.theme.cartDrawer.open();
                } else {
                  window.location.href = '{{ routes.cart_url }}';
                }
              } else {
                hideLoading(submitBtn);
                const errorMsg = data.error || data.description || 'Грешка при добавяне в кошницата. Моля, опитайте отново.';
                showError(errorMsg);
              }
            });
          })
          .catch(error => {
            hideLoading(submitBtn);
            showError('Грешка при добавяне в кошницата. Моля, опитайте отново.');
          });
        });
      }
      
      const addToCartForms = root.querySelectorAll('.pfc-form:not(.pfc-form-complete-set)');
      addToCartForms.forEach(form => {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const formData = new FormData(this);
          const submitBtn = this.querySelector('button[type="submit"]');
          
          if (!submitBtn) return;
          
          showLoading(submitBtn);
          
          fetch('{{ routes.cart_add_url }}.js', {
            method: 'POST',
            body: formData,
            headers: {
              'Accept': 'application/json'
            }
          })
          .then(response => {
            return response.json().then(data => {
              if (response.ok && !data.error) {
                showSuccess(submitBtn, 'Продуктът е добавен в количката!');
                
                if (typeof document.dispatchEvent !== 'undefined') {
                  document.dispatchEvent(new CustomEvent('cart:updated'));
                }
                
                if (window.Shopify?.theme?.cartDrawer?.open) {
                  window.Shopify.theme.cartDrawer.open();
                } else {
                  window.location.href = '{{ routes.cart_url }}';
                }
              } else {
                hideLoading(submitBtn);
                const errorMsg = data.error || data.description || 'Грешка при добавяне в кошницата. Моля, опитайте отново.';
                showError(errorMsg);
              }
            });
          })
          .catch(error => {
            hideLoading(submitBtn);
            showError('Грешка при добавяне в кошницата. Моля, опитайте отново.');
          });
        });
      });


      function smoothScrollTo(el) {
        if (!el) return;
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile) {
          el.scrollIntoView({ behavior: 'auto', block: 'start' });
          setTimeout(function() {
            window.scrollBy({ top: -80, behavior: 'auto' });
          }, 0);
        } else {
          var rect = el.getBoundingClientRect();
          var offset = window.pageYOffset || document.documentElement.scrollTop;
          var top = rect.top + offset - 80;
          window.scrollTo({ top: top, behavior: 'smooth' });
        }
      }

      var sampleButtons = root.querySelectorAll('[data-scroll-to="sample"]');
      var calcButtons = root.querySelectorAll('[data-scroll-to="calculator"]');
      var calcBlock = root.querySelector('[data-calculator-block]');

      sampleButtons.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          smoothScrollTo(sampleBox);
        });
      });

      calcButtons.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          smoothScrollTo(calcBlock);
        });
      });

    })();

    // Sample Box Logic
    document.addEventListener('DOMContentLoaded', function() {
      var sampleBox = document.querySelector('[data-sample-box]');
      var form = sampleBox ? sampleBox.querySelector('[data-sample-form]') : null;
      var overlay = sampleBox ? sampleBox.querySelector('[data-sample-overlay]') : null;
      var popup = sampleBox ? sampleBox.querySelector('[data-sample-popup]') : null;
      var closeBtn = sampleBox ? sampleBox.querySelector('[data-sample-close]') : null;
      var maxSamples = {{ sample_limit | default: 3 }};

      function showPopup() {
        if (!sampleBox || !popup || !overlay) return;
        sampleBox.classList.add('is-visible');
        if (popup) popup.setAttribute('aria-hidden', 'false');
      }

      function hidePopup() {
        if (!sampleBox) return;
        sampleBox.classList.remove('is-visible');
        if (popup) popup.setAttribute('aria-hidden', 'true');
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', hidePopup);
      }
      if (overlay) {
        overlay.addEventListener('click', hidePopup);
      }

      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();

          fetch('{{ routes.cart_url }}.js', { credentials: 'same-origin' })
            .then(function(res) { return res.json(); })
            .then(function(cart) {
              var currentSamples = 0;
              if (cart.items && Array.isArray(cart.items)) {
                cart.items.forEach(function(item) {
                  var title = (item.product_title || '').toLowerCase();
                  if (title.indexOf('безплатна мостра') === 0) {
                    currentSamples += item.quantity || 0;
                  }
                });
              }

              var qtyInput = form.querySelector('input[name="quantity"]');
              var addQty = qtyInput ? parseInt(qtyInput.value || '1', 10) : 1;

              if ((currentSamples + addQty) > maxSamples) {
                alert('Може да поръчате до ' + maxSamples + ' безплатни мостри в една поръчка.');
                return;
              }

              var formData = new FormData(form);
              fetch('{{ routes.cart_add_url }}.js', {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin'
              })
              .then(function(res) { return res.json(); })
              .then(function(data) {
                if (data.status && data.status !== 'success' && data.error) {
                  throw new Error(data.error || 'Failed to add to cart');
                }
                showPopup();
                // Trigger cart update events
                if (typeof document.dispatchEvent !== 'undefined') {
                  document.dispatchEvent(new CustomEvent('cart:updated'));
                }
                if (window.Shopify && window.Shopify.theme && window.Shopify.theme.cartDrawer && typeof window.Shopify.theme.cartDrawer.open === 'function') {
                  window.Shopify.theme.cartDrawer.open();
                }
              })
              .catch(function(err) {
                console.error(err);
                alert('Възникна грешка при добавяне на мострата.');
              });
            })
            .catch(function(err) {
              console.error(err);
              alert('Възникна грешка при проверка на количката.');
            });
        });
      }
      });
      var tooltipClickTimeout = null;
      document.addEventListener('click', function(e) {
        if (tooltipClickTimeout) return;
        tooltipClickTimeout = requestAnimationFrame(function() {
          var info = e.target.closest('.pfc-waste-info');
          var allTooltips = document.querySelectorAll('.pfc-waste-tooltip');

          if (info) {
            e.preventDefault();
            e.stopPropagation();

            var tooltip = info.querySelector('.pfc-waste-tooltip');
            if (!tooltip) {
              tooltipClickTimeout = null;
              return;
            }

            var isVisible = tooltip.style.display === 'block';

            allTooltips.forEach(function(t) {
              t.style.display = 'none';
            });

            tooltip.style.display = isVisible ? 'none' : 'block';
            tooltipClickTimeout = null;
            return;
          }

          allTooltips.forEach(function(t) {
            t.style.display = 'none';
          });
          tooltipClickTimeout = null;
        });
      }, { passive: true });

    // ГЛОБАЛНА ЗАЩИТА ОТ БЛОКИРАН СКРОЛ - предотвратява проблеми със скрола на мобилни
    (function() {
      'use strict';
      function ensureScrollUnlocked() {
        const zoomModal = document.querySelector('.pfc-gallery__zoom-modal.is-open');
        const sampleBox = document.querySelector('[data-sample-box].is-visible');
        
        // Ако няма отворени модали, винаги възстанови скрола
        if (!zoomModal && !sampleBox) {
          document.body.style.overflow = '';
          document.body.style.position = '';
          document.body.style.top = '';
          document.body.style.width = '';
          document.documentElement.style.overflow = '';
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ensureScrollUnlocked);
      } else {
        ensureScrollUnlocked();
      }
      
      // Проверка при видимост на страницата (когато се върнеш от друг таб)
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          ensureScrollUnlocked();
        }
      });
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                    (window.innerWidth <= 768 && 'ontouchstart' in window);
      if (isMobile) {
        setInterval(function() {
          ensureScrollUnlocked();
        }, 500);
      }
    })();
  </script>
</section>
{% endif %}

{% schema %}
{
  "name": "Product Card",
  "tag": "section",
  "class": "pfc-section-wrapper",
  "settings": [
    {
      "type": "text",
      "id": "kicker",
      "label": "Kicker Текст",
      "default": "Бестселър",
      "info": "Малък текст над заглавието"
    },
    {
      "type": "text",
      "id": "custom_title",
      "label": "Персонализирано заглавие",
      "info": "Използва се, ако не е избран продукт"
    },
    {
      "type": "image_picker",
      "id": "placeholder_image",
      "label": "Снимка-заместител",
      "info": "Използва се, ако не е избран продукт"
    },
    {
      "type": "text",
      "id": "manual_price",
      "label": "Ръчна цена",
      "info": "Използва се, ако не е избран продукт (напр., 99.99 лв.)"
    },
    {
      "type": "header",
      "content": "Наличност и доставка"
    },
    {
      "type": "checkbox",
      "id": "show_delivery_info",
      "label": "Покажи информация за доставка",
      "default": true
    },
    {
      "type": "text",
      "id": "delivery_text",
      "label": "Текст за доставка",
      "default": "Доставка за 3–5 дни"
    },
    {
      "type": "text",
      "id": "in_stock_label",
      "label": "Етикет за наличност",
      "default": "В наличност"
    },
    {
      "type": "text",
      "id": "out_of_stock_label",
      "label": "Етикет за липсващ продукт",
      "default": "Не е наличен"
    },
    {
      "type": "header",
      "content": "Бутони"
    },
    {
      "type": "color",
      "id": "button_primary_bg",
      "label": "Основен бутон - Фон",
      "default": "#18a957"
    },
    {
      "type": "color",
      "id": "button_primary_text",
      "label": "Основен бутон - Текст",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_primary_border",
      "label": "Основен бутон - Граница",
      "default": "#0e8d46"
    },
    {
      "type": "color",
      "id": "button_primary_hover",
      "label": "Основен бутон - Hover",
      "default": "#159348"
    },
    {
      "type": "color",
      "id": "button_secondary_bg",
      "label": "Вторичен бутон - Фон",
      "default": "#ff6a00"
    },
    {
      "type": "color",
      "id": "button_secondary_text",
      "label": "Вторичен бутон - Текст",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_secondary_border",
      "label": "Вторичен бутон - Граница",
      "default": "#e05400"
    },
    {
      "type": "color",
      "id": "button_secondary_hover",
      "label": "Вторичен бутон - Hover",
      "default": "#e55f00"
    },
    {
      "type": "color",
      "id": "button_sample_bg",
      "label": "Бутон за проба - Фон",
      "default": "#18a957"
    },
    {
      "type": "color",
      "id": "button_sample_text",
      "label": "Бутон за проба - Текст",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_sample_border",
      "label": "Бутон за проба - Граница",
      "default": "#0e8d46"
    },
    {
      "type": "color",
      "id": "button_sample_hover",
      "label": "Бутон за проба - Hover",
      "default": "#159348"
    },
    {
      "type": "color",
      "id": "button_virtual_bg",
      "label": "Виртуален бутон - Фон",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_virtual_text",
      "label": "Виртуален бутон - Текст",
      "default": "#ff6a00"
    },
    {
      "type": "color",
      "id": "button_virtual_border",
      "label": "Виртуален бутон - Граница",
      "default": "#ff6a00"
    },
    {
      "type": "color",
      "id": "button_virtual_hover",
      "label": "Виртуален бутон - Hover",
      "default": "#fff5f0"
    },
    {
      "type": "color",
      "id": "button_request_offer_bg",
      "label": "Бутон за оферта - Фон",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_request_offer_text",
      "label": "Бутон за оферта - Текст",
      "default": "#ff6a00"
    },
    {
      "type": "color",
      "id": "button_request_offer_border",
      "label": "Бутон за оферта - Граница",
      "default": "#ff6a00"
    },
    {
      "type": "color",
      "id": "button_request_offer_hover_bg",
      "label": "Бутон за оферта - Hover Фон",
      "default": "#ff6a00"
    },
    {
      "type": "color",
      "id": "button_request_offer_hover_text",
      "label": "Бутон за оферта - Hover Текст",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_collection_bg",
      "label": "Бутон в категория - Фон",
      "default": "#18a957"
    },
    {
      "type": "color",
      "id": "button_collection_text",
      "label": "Бутон в категория - Текст",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_collection_hover",
      "label": "Бутон в категория - Hover",
      "default": "#15803d"
    },
    {
      "type": "text",
      "id": "quantity_label",
      "label": "Етикет за количество",
      "default": "Количество"
    },
    {
      "type": "text",
      "id": "cta_label",
      "label": "Етикет на бутона за добавяне в количката",
      "default": "Добави в количката"
    },
    {
      "type": "url",
      "id": "cta_link",
      "label": "CTA Линк",
      "info": "Използва се, когато не е избран продукт"
    },
    {
      "type": "text",
      "id": "sold_out_label",
      "label": "Етикет на бутона за разпродаден",
      "default": "Разпродадено"
    },
    {
      "type": "text",
      "id": "adding_label",
      "label": "Етикет при добавяне",
      "default": "Добавяне...",
      "info": "Показва се по време на добавяне в количката"
    },
    {
      "type": "text",
      "id": "added_label",
      "label": "Етикет при добавен",
      "default": "Добавено!",
      "info": "Показва се след успешно добавяне в количката"
    },
    {
      "type": "text",
      "id": "error_label",
      "label": "Етикет за грешка",
      "default": "Грешка при добавяне в количката. Моля, опитайте отново.",
      "info": "Съобщение за грешка, ако добавянето в количката не успее"
    },
    {
      "type": "text",
      "id": "secondary_label",
      "label": "Етикет на вторичен бутон",
      "info": "Опционален оранжев бутон (напр., 'Задайте въпрос')"
    },
    {
      "type": "url",
      "id": "secondary_link",
      "label": "Линк на вторичен бутон"
    },
    {
      "type": "header",
      "content": "Бадж на снимката"
    },
    {
      "type": "text",
      "id": "image_badge_text",
      "label": "Текст на бадж за снимка",
      "info": "Бадж наложен върху главната снимка на продукта (напр., '-44% BLACK WEEKS')"
    },
    {
      "type": "header",
      "content": "Информация за продукта"
    },
    {
      "type": "checkbox",
      "id": "show_metafields",
      "label": "Покажи метафилдове",
      "default": false,
      "info": "Активирайте, за да покажете метафилдовете на продукта."
    },
    {
      "type": "checkbox",
      "id": "auto_show_all_metafields",
      "label": "Автоматично показване на всички метафилдове",
      "default": true,
      "info": "Автоматично намира и показва всички метафилдове на продукта без нужда от ръчно добавяне на блокове."
    },
    {
      "type": "text",
      "id": "auto_metafields_namespace",
      "label": "Namespace за автоматично показване",
      "default": "custom",
      "info": "Namespace от който да се показват автоматично метафилдовете (напр. 'custom', 'global', 'product')"
    },
    {
      "type": "checkbox",
      "id": "show_empty_metafields",
      "label": "Покажи празни метафилдове",
      "default": false,
      "info": "Показва метафилдове дори ако нямат стойност (при автоматично показване)"
    },
    {
      "type": "text",
      "id": "empty_metafield_text",
      "label": "Текст за празни метафилдове",
      "default": "—",
      "info": "Текст който да се показва за празни метафилдове (при автоматично показване)"
    },
    {
      "type": "checkbox",
      "id": "show_price_per_unit",
      "label": "Покажи цена на единица",
      "default": true,
      "info": "Покажи /m² след цената"
    },
    {
      "type": "checkbox",
      "id": "hide_package_price_top",
      "label": "Скрий цена на пакет в горната част",
      "default": false,
      "info": "Ако е активирано, цената на пакет няма да се показва под основната цена в горната част на страницата"
    },
    {
      "type": "header",
      "content": "Цветови настройки за цени"
    },
    {
      "type": "color",
      "id": "price_unit_color",
      "label": "Цвят на цена за квадратен метър",
      "default": "#111827",
      "info": "Цвят на основната цена (цена на m²)"
    },
    {
      "type": "color",
      "id": "price_package_color",
      "label": "Цвят на цена на пакет",
      "default": "#111827",
      "info": "Цвят на цената на пакет (вторична цена)"
    },
    {
      "type": "color",
      "id": "price_compare_color",
      "label": "Цвят на зачеркната цена",
      "default": "#9ca3af",
      "info": "Цвят на compare_at_price (зачеркната цена)"
    },
    {
      "type": "color",
      "id": "price_eur_color",
      "label": "Цвят на EUR цена",
      "default": "#111827",
      "info": "Цвят на EUR частта от цената"
    },
    {
      "type": "color",
      "id": "price_calculator_color",
      "label": "Цвят на цена в калкулатора",
      "default": "#111827",
      "info": "Цвят на цените в калкулатора"
    },
    {
      "type": "color",
      "id": "price_total_color",
      "label": "Цвят на обща цена",
      "default": "#111827",
      "info": "Цвят на общата цена (total)"
    },
    {
      "type": "header",
      "content": "Цветови настройки за текстове в калкулатора"
    },
    {
      "type": "color",
      "id": "calculator_label_color",
      "label": "Цвят на етикети (Количество, Пакети, Покривна площ)",
      "default": "#374151",
      "info": "Цвят на текстовете-етикети в калкулатора"
    },
    {
      "type": "color",
      "id": "calculator_value_color",
      "label": "Цвят на стойности (числа и цени)",
      "default": "#111827",
      "info": "Цвят на числените стойности и цените в калкулатора"
    },
    {
      "type": "color",
      "id": "calculator_package_info_color",
      "label": "Цвят на информация за пакет (Съдържание, Цена на пакет)",
      "default": "#6b7280",
      "info": "Цвят на информацията за пакета"
    },
    {
      "type": "color",
      "id": "calculator_total_label_color",
      "label": "Цвят на 'Общо:' етикет",
      "default": "#111827",
      "info": "Цвят на етикета 'Общо:'"
    },
    {
      "type": "color",
      "id": "calculator_button_color",
      "label": "Цвят на бутоните",
      "default": "#111827",
      "info": "Цвят на бутоните + и - в калкулатора"
    },
    {
      "type": "text",
      "id": "unit_label",
      "label": "Етикет за единица",
      "default": "m²",
      "info": "Единица за измерване (m², кв. фут и т.н.). Може да се презапише с metafield 'custom.calculator_unit_label' за всеки продукт."
    },
    {
      "type": "header",
      "content": "Функции"
    },
    {
      "type": "checkbox",
      "id": "enable_currency_conversion",
      "label": "Активирай конвертиране в EUR",
      "default": false,
      "info": "Активирайте конвертирането на цените от BGN в EUR"
    },
    {
      "type": "text",
      "id": "eur_to_bgn_rate",
      "label": "Курс EUR към BGN",
      "default": "1.95583",
      "info": "Курс за конвертиране от EUR към BGN (по подразбиране: 1.95583)"
    },
    {
      "type": "checkbox",
      "id": "show_eur_alongside_bgn",
      "label": "Показва цената в EUR до BGN (от A)",
      "default": false,
      "info": "Показва цената в EUR до цената в BGN"
    },
    {
      "type": "header",
      "content": "Секция за пълен комплект"
    },
    {
      "type": "checkbox",
      "id": "show_complete_set",
      "label": "Покажи секция за пълен комплект",
      "default": false,
      "info": "Активирайте секцията за покупка на пълен комплект с калкулатор m²"
    },
    {
      "type": "product",
      "id": "complete_set_target_product",
      "label": "Покажи секция за пълен комплект за продукт",
      "info": "ЗАДЪЛЖИТЕЛНО: Изберете основен продукт, за който да се показва секцията. Секцията ще се показва САМО за избрания продукт."
    },
    {
      "type": "checkbox",
      "id": "enable_calculator",
      "label": "Активирай калкулатор (за шаблони)",
      "default": false,
      "info": "Активирайте калкулатора за всички продукти. Персонализация чрез metafields: calculator_package_size, calculator_waste_percent, и т.н."
    },
    {
      "type": "checkbox",
      "id": "enable_promo_banner",
      "label": "Активирай промо банер (за шаблони)",
      "default": false,
      "info": "Активирайте промо банер директно от шаблона, без да използвате metafield. Ако е активирано, банерът ще се показва независимо от metafield."
    },
    {
      "type": "header",
      "content": "Бадж за спестявания"
    },
    {
      "type": "checkbox",
      "id": "show_savings_badge",
      "label": "Покажи бадж за спестявания",
      "default": true
    },
    {
      "type": "text",
      "id": "savings_label",
      "label": "Етикет за спестявания",
      "default": "You save",
      "info": "Текстът преди процента (напр., 'You save', 'Спестявате')"
    },
    {
      "type": "text",
      "id": "savings_badge_format",
      "label": "Формат на текста",
      "default": "LABEL_PLACEHOLDER PERCENT_PLACEHOLDER%",
      "info": "Персонализиран формат. Използвайте LABEL_PLACEHOLDER за етикета и PERCENT_PLACEHOLDER за процента. Пример: 'LABEL_PLACEHOLDER PERCENT_PLACEHOLDER%' или 'PERCENT_PLACEHOLDER% OFF'. Оставете празно за стандартен формат."
    },
    {
      "type": "text",
      "id": "manual_savings_percent",
      "label": "Ръчен процент спестявания",
      "info": "Използва се, ако не е избран продукт (напр., 17)"
    },
    {
      "type": "color",
      "id": "savings_badge_bg",
      "label": "Цвят на фона",
      "default": "#dc2626",
      "info": "Цвятът на фона на баджа"
    },
    {
      "type": "color",
      "id": "savings_badge_text",
      "label": "Цвят на текста",
      "default": "#ffffff",
      "info": "Цвятът на текста в баджа"
    },
    {
      "type": "range",
      "id": "savings_badge_font_size",
      "label": "Размер на текста (px)",
      "min": 10,
      "max": 24,
      "step": 1,
      "default": 14,
      "info": "Размерът на текста в пиксели"
    },
    {
      "type": "range",
      "id": "savings_badge_padding",
      "label": "Вътрешен отстъп вертикален (px)",
      "min": 4,
      "max": 20,
      "step": 1,
      "default": 8,
      "info": "Отстъпът отгоре и отдолу"
    },
    {
      "type": "range",
      "id": "savings_badge_padding_horizontal",
      "label": "Вътрешен отстъп хоризонтален (px)",
      "min": 8,
      "max": 30,
      "step": 1,
      "default": 12,
      "info": "Отстъпът отляво и отдясно"
    },
    {
      "type": "range",
      "id": "savings_badge_border_radius",
      "label": "Закръгляне на ъглите (px)",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 8,
      "info": "Колко закръглени да бъдат ъглите"
    },
    {
      "type": "select",
      "id": "savings_badge_align",
      "label": "Подравняване на текста",
      "options": [
        {
          "value": "left",
          "label": "Ляво"
        },
        {
          "value": "center",
          "label": "Център"
        },
        {
          "value": "right",
          "label": "Дясно"
        }
      ],
      "default": "center",
      "info": "Как да се подравни текстът в баджа"
    },
    {
      "type": "textarea",
      "id": "savings_badge_custom_css",
      "label": "Персонализиран CSS",
      "info": "Допълнителни CSS стилове за баджа (напр., font-weight: bold; text-transform: uppercase;)"
    },
    {
      "type": "number",
      "id": "default_quantity",
      "label": "Количество по подразбиране (m²)",
      "default": 10,
      "info": "Количество по подразбиране в квадратни метри. Може да се презапише с metafield 'custom.calculator_default_quantity' за всеки продукт."
    },
    {
      "type": "number",
      "id": "min_quantity",
      "label": "Минимално количество",
      "default": 1,
      "info": "Минимална стойност в калкулатора. Може да се презапише с metafield 'custom.calculator_min_quantity' за всеки продукт."
    },
    {
      "type": "number",
      "id": "quantity_step",
      "label": "Стъпка на количеството",
      "default": 1,
      "info": "Стъпка за увеличаване/намаляване. Може да се презапише с metafield 'custom.calculator_quantity_step' за всеки продукт."
    },
    {
      "type": "checkbox",
      "id": "show_package_calculation",
      "label": "Покажи изчисление на пакети",
      "default": true
    },
    {
      "type": "text",
      "id": "package_size",
      "label": "Размер на пакет (m²)",
      "default": "2.196",
      "info": "Квадратни метри на пакет (напр., 2.196). Може да се презапише с metafield 'custom.calculator_package_size' за всеки продукт."
    },
    {
      "type": "text",
      "id": "package_label",
      "label": "Етикет за пакет",
      "default": "Пакети"
    },
    {
      "type": "checkbox",
      "id": "show_waste_option",
      "label": "Покажи опция за фира",
      "default": true
    },
    {
      "type": "number",
      "id": "waste_percent",
      "label": "Процент фира",
      "default": 5,
      "info": "Процент фира (допълнително количество за рязане и брак) по подразбиране. Може да се презапише с metafield 'custom.calculator_waste_percent' за всеки продукт."
    },
    {
      "type": "text",
      "id": "waste_label",
      "label": "Етикет за фира",
      "default": "5% фира"
    },
    {
      "type": "text",
      "id": "waste_info",
      "label": "Tooltip за информация за фира",
      "default": "Фира е допълнително количество за рязане и брак.",
      "info": "Текст на малко балонче до отметката за фира – напр. „Препоръчваме да добавите 10% фира за рязане и евентуален брак.“"
    },
    {
      "type": "checkbox",
      "id": "show_package_details",
      "label": "Покажи детайли за пакета",
      "default": true
    },
    {
      "type": "text",
      "id": "package_content_label",
      "label": "Етикет за съдържание на пакет",
      "default": "Съдържание на пакет"
    },
    {
      "type": "text",
      "id": "package_price_label",
      "label": "Етикет за цена на пакет",
      "default": "Цена на пакет"
    },
    {
      "type": "text",
      "id": "manual_package_price",
      "label": "Ръчна цена на пакет",
      "info": "Използва се, ако не е избран продукт"
    },
    {
      "type": "text",
      "id": "total_label",
      "label": "Етикет за общо",
      "default": "Общо"
    },
    {
      "type": "text",
      "id": "saved_label",
      "label": "Етикет за спестено",
      "default": "спестено"
    },
    {
      "type": "text",
      "id": "manual_total",
      "label": "Ръчно общо",
      "info": "Използва се, ако не е избран продукт"
    },
    {
      "type": "text",
      "id": "promo_label",
      "label": "Етикет за промоция",
      "default": "Промоция"
    },
    {
      "type": "checkbox",
      "id": "show_request_offer",
      "label": "Покажи бутон за заявка на оферта",
      "default": false
    },
    {
      "type": "text",
      "id": "request_offer_label",
      "label": "Етикет за заявка на оферта",
      "default": "Заяви оферта"
    },
    {
      "type": "url",
      "id": "request_offer_link",
      "label": "Линк за заявка на оферта"
    },
    {
      "type": "header",
      "content": "Промоционална оферта"
    },
    {
      "type": "header",
      "content": "Действия бутони"
    },
    {
      "type": "checkbox",
      "id": "show_sample_button",
      "label": "Покажи бутон за проба",
      "default": false
    },
    {
      "type": "text",
      "id": "sample_button_label",
      "label": "Етикет на бутон за проба",
      "default": "Поръчай безплатна проба"
    },
    {
      "type": "url",
      "id": "sample_button_link",
      "label": "Линк на бутон за проба"
    },
    {
      "type": "header",
      "content": "Калкулатор и мостра"
    },
    {
      "type": "product",
      "id": "calculator_product",
      "label": "Продукт с калкулатор",
      "info": "Изберете продукт за калкулатор"
    },
    {
      "type": "checkbox",
      "id": "calculator_override_metafield",
      "label": "Презапиши metafield",
      "default": false,
      "info": "Игнорира metafield за калкулатор"
    },
    {
      "type": "product",
      "id": "sample_product_main",
      "label": "Основен продукт",
      "info": "За кой продукт е мострата"
    },
    {
      "type": "product",
      "id": "sample_product_override",
      "label": "Sample продукт",
      "info": "Изберете sample продукта"
    },
    {
      "type": "checkbox",
      "id": "sample_override_metafield",
      "label": "Презапиши metafield",
      "default": false,
      "info": "Игнорира metafield за мостра"
    },
    {
      "type": "header",
      "content": "Настройки за popup на мостра"
    },
    {
      "type": "number",
      "id": "sample_limit",
      "label": "Максимален брой мостри",
      "default": 3,
      "info": "Максимален брой безплатни мостри на поръчка. Може да се презапише с metafield 'custom.sample_limit' за всеки продукт."
    },
    {
      "type": "text",
      "id": "sample_popup_title",
      "label": "Заглавие на popup",
      "default": "Мострата е добавена в количката",
      "info": "Заглавието, което се показва в popup-а след добавяне на мостра"
    },
    {
      "type": "textarea",
      "id": "sample_popup_text",
      "label": "Текст на popup",
      "default": "Можеш да добавиш още до 3 мостри общо в една поръчка.",
      "info": "Текстът, който се показва в popup-а"
    },
    {
      "type": "text",
      "id": "sample_popup_close_label",
      "label": "Етикет на бутон 'Затвори'",
      "default": "Продължи да разглеждаш",
      "info": "Текстът на бутона за затваряне на popup-а"
    },
    {
      "type": "text",
      "id": "sample_popup_cart_label",
      "label": "Етикет на бутон 'Към количката'",
      "default": "Към количката",
      "info": "Текстът на бутона, който води към количката"
    },
    {
      "type": "checkbox",
      "id": "show_virtual_button",
      "label": "Покажи виртуален бутон",
      "default": false
    },
    {
      "type": "text",
      "id": "virtual_button_label",
      "label": "Етикет на виртуален бутон",
      "default": "Виртуално полагане на подова настилка"
    },
    {
      "type": "url",
      "id": "virtual_button_link",
      "label": "Линк на виртуален бутон"
    },
    {
      "type": "header",
      "content": "Икони за плащане"
    },
    {
      "type": "checkbox",
      "id": "show_payment_icons",
      "label": "Покажи икони за плащане",
      "default": false
    },
    {
      "type": "text",
      "id": "payment_icons_text",
      "label": "Етикет за икони за плащане",
      "info": "Опционален текст над иконите за плащане"
    },
  ],
  "blocks": [
    {
      "type": "gallery_image",
      "name": "Снимка в галерията",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Снимка"
        },
        {
          "type": "text",
          "id": "alt",
          "label": "Alt Text"
        }
      ]
    },
    {
      "type": "badge",
      "name": "Бадж",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Текст на бадж",
          "default": "BLACK WEEK -48%"
        },
        {
          "type": "select",
          "id": "variant",
          "label": "Цвят на бадж",
          "options": [
            {
              "value": "orange",
              "label": "Оранжев"
            },
            {
              "value": "green",
              "label": "Зелен"
            }
          ],
          "default": "orange"
        }
      ]
    },
    {
      "type": "checklist_item",
      "name": "Елемент от чеклиста",
      "settings": [
        {
          "type": "header",
          "content": "Филтриране и персонализация"
        },
        {
          "type": "select",
          "id": "filter_type",
          "label": "Тип филтриране",
          "options": [
            {
              "value": "any",
              "label": "ИЛИ (покажи ако е изпълнено кое и да е условие)"
            },
            {
              "value": "all",
              "label": "И (покажи ако са изпълнени всички условия)"
            }
          ],
          "default": "any",
          "info": "Изберете дали условията трябва да са изпълнени всички (И) или поне едно (ИЛИ)"
        },
        {
          "type": "product",
          "id": "target_product",
          "label": "Покажи за продукт",
          "info": "Изберете продукт, за който да се показва този елемент от чеклиста. Ако не е избран, ще се показва за всички продукти."
        },
        {
          "type": "collection",
          "id": "target_collection",
          "label": "Покажи за колекция",
          "info": "Изберете колекция - елементът ще се показва за всички продукти в тази колекция."
        },
        {
          "type": "text",
          "id": "required_tags",
          "label": "Задължителни тагове",
          "info": "Въведете тагове разделени със запетая (напр. premium,new,featured). Продуктът трябва да има ВСИЧКИ тагове."
        },
        {
          "type": "text",
          "id": "metafield_namespace",
          "label": "Метафилд Namespace",
          "default": "custom",
          "info": "Namespace на метафилда (напр. custom, global, product)"
        },
        {
          "type": "text",
          "id": "metafield_key",
          "label": "Метафилд Key",
          "info": "Key на метафилда за филтриране (напр. show_checklist, category_type)"
        },
        {
          "type": "text",
          "id": "metafield_value",
          "label": "Метафилд Стойност",
          "info": "Стойност на метафилда, която трябва да съвпада (оставете празно за проверка само за наличие)"
        },
        {
          "type": "header",
          "content": "Съдържание"
        },
        {
          "type": "text",
          "id": "text",
          "label": "Текст от чеклиста",
          "default": "Waterproof | Class 33/AC5"
        },
        {
          "type": "checkbox",
          "id": "use_metafield_text",
          "label": "Използвай метафилд за текст",
          "default": false,
          "info": "Ако е активирано, текстът ще се взима от метафилд на продукта"
        },
        {
          "type": "text",
          "id": "text_metafield_namespace",
          "label": "Text Метафилд Namespace",
          "default": "custom",
          "info": "Namespace за метафилда на текста"
        },
        {
          "type": "text",
          "id": "text_metafield_key",
          "label": "Text Метафилд Key",
          "info": "Key за метафилда на текста (напр. checklist_text)"
        }
      ]
    },
    {
      "type": "addon",
      "name": "Карта за услуга/добавка",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Икона снимка"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Заглавие",
          "default": "Professional Installation"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Подзаглавие",
          "default": "Fast scheduling, fixed price"
        },
        {
          "type": "text",
          "id": "link_label",
          "label": "Етикет на бутон",
          "default": "More"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Линк на бутон",
        }
      ]
    },
    {
      "type": "accordion",
      "name": "Панел на акордеон",
      "settings": [
        {
          "type": "header",
          "content": "Филтриране и персонализация"
        },
        {
          "type": "select",
          "id": "filter_type",
          "label": "Тип филтриране",
          "options": [
            {
              "value": "any",
              "label": "ИЛИ (покажи ако е изпълнено кое и да е условие)"
            },
            {
              "value": "all",
              "label": "И (покажи ако са изпълнени всички условия)"
            }
          ],
          "default": "any",
          "info": "Изберете дали условията трябва да са изпълнени всички (И) или поне едно (ИЛИ)"
        },
        {
          "type": "product",
          "id": "target_product",
          "label": "Покажи за продукт",
          "info": "Изберете продукт, за който да се показва този акордеон панел. Ако не е избран, ще се показва за всички продукти."
        },
        {
          "type": "collection",
          "id": "target_collection",
          "label": "Покажи за колекция",
          "info": "Изберете колекция - панелът ще се показва за всички продукти в тази колекция."
        },
        {
          "type": "text",
          "id": "required_tags",
          "label": "Задължителни тагове",
          "info": "Въведете тагове разделени със запетая (напр. premium,new,featured). Продуктът трябва да има ВСИЧКИ тагове."
        },
        {
          "type": "text",
          "id": "metafield_namespace",
          "label": "Метафилд Namespace",
          "default": "custom",
          "info": "Namespace на метафилда (напр. custom, global, product)"
        },
        {
          "type": "text",
          "id": "metafield_key",
          "label": "Метафилд Key",
          "info": "Key на метафилда за филтриране (напр. show_accordion, category_type)"
        },
        {
          "type": "text",
          "id": "metafield_value",
          "label": "Метафилд Стойност",
          "info": "Стойност на метафилда, която трябва да съвпада (оставете празно за проверка само за наличие)"
        },
        {
          "type": "header",
          "content": "Съдържание"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Заглавие на панел",
          "default": "Technical Specifications"
        },
        {
          "type": "checkbox",
          "id": "use_metafield_title",
          "label": "Използвай метафилд за заглавие",
          "default": false,
          "info": "Ако е активирано, заглавието ще се взима от метафилд на продукта"
        },
        {
          "type": "text",
          "id": "title_metafield_namespace",
          "label": "Title Метафилд Namespace",
          "default": "custom",
          "info": "Namespace за метафилда на заглавието"
        },
        {
          "type": "text",
          "id": "title_metafield_key",
          "label": "Title Метафилд Key",
          "info": "Key за метафилда на заглавието (напр. accordion_title)"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Panel Content",
          "default": "<p>Thickness: 5.5 mm · Wear layer: 0.5 mm · Package: 2.235 m²</p>"
        },
        {
          "type": "checkbox",
          "id": "use_metafield_content",
          "label": "Използвай метафилд за съдържание",
          "default": false,
          "info": "Ако е активирано, съдържанието ще се взима от метафилд на продукта"
        },
        {
          "type": "text",
          "id": "content_metafield_namespace",
          "label": "Content Метафилд Namespace",
          "default": "custom",
          "info": "Namespace за метафилда на съдържанието"
        },
        {
          "type": "text",
          "id": "content_metafield_key",
          "label": "Content Метафилд Key",
          "info": "Key за метафилда на съдържанието (напр. accordion_content)"
        },
        {
          "type": "checkbox",
          "id": "open_by_default",
          "label": "Open by Default",
          "default": false
        }
      ]
    },
    {
      "type": "promo_addon",
      "name": "Promotional Add-on",
      "settings": [
        {
          "type": "header",
          "content": "Филтриране и персонализация"
        },
        {
          "type": "select",
          "id": "filter_type",
          "label": "Тип филтриране",
          "options": [
            {
              "value": "any",
              "label": "ИЛИ (покажи ако е изпълнено кое и да е условие)"
            },
            {
              "value": "all",
              "label": "И (покажи ако са изпълнени всички условия)"
            }
          ],
          "default": "any",
          "info": "Изберете дали условията трябва да са изпълнени всички (И) или поне едно (ИЛИ). Забележка: enable_promo_banner в секцията има приоритет."
        },
        {
          "type": "product",
          "id": "target_product",
          "label": "За кой основен продукт",
          "info": "Изберете основен продукт, за който да се показва този upsell. Ако не е избран, ще се показва за всички продукти (освен ако не са зададени други условия)."
        },
        {
          "type": "collection",
          "id": "target_collection",
          "label": "Покажи за колекция",
          "info": "Изберете колекция - add-on-ът ще се показва за всички продукти в тази колекция."
        },
        {
          "type": "text",
          "id": "required_tags",
          "label": "Задължителни тагове",
          "info": "Въведете тагове разделени със запетая (напр. premium,new,featured). Продуктът трябва да има ВСИЧКИ тагове."
        },
        {
          "type": "text",
          "id": "metafield_namespace",
          "label": "Метафилд Namespace",
          "default": "custom",
          "info": "Namespace на метафилда (напр. custom, global, product)"
        },
        {
          "type": "text",
          "id": "metafield_key",
          "label": "Метафилд Key",
          "info": "Key на метафилда за филтриране (напр. show_promo, promo_type)"
        },
        {
          "type": "text",
          "id": "metafield_value",
          "label": "Метафилд Стойност",
          "info": "Стойност на метафилда, която трябва да съвпада (оставете празно за проверка само за наличие)"
        },
        {
          "type": "header",
          "content": "Продукт и съдържание"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product",
          "info": "Select product to add to cart. If not selected, will show manual price."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Add-on Image",
          "info": "Optional image for the add-on. If not set and product is selected, will use product image."
        },
        {
          "type": "text",
          "id": "title",
          "label": "Add-on Title",
          "default": "Modern Skirting Board White 240cm",
          "info": "Will use product title if product is selected"
        },
        {
          "type": "checkbox",
          "id": "use_metafield_title",
          "label": "Използвай метафилд за заглавие",
          "default": false,
          "info": "Ако е активирано, заглавието ще се взима от метафилд на основния продукт"
        },
        {
          "type": "text",
          "id": "title_metafield_namespace",
          "label": "Title Метафилд Namespace",
          "default": "custom",
          "info": "Namespace за метафилда на заглавието"
        },
        {
          "type": "text",
          "id": "title_metafield_key",
          "label": "Title Метафилд Key",
          "info": "Key за метафилда на заглавието (напр. promo_title)"
        },
        {
          "type": "number",
          "id": "quantity",
          "label": "Default Quantity",
          "default": 1,
          "info": "Default quantity for add to cart"
        },
        {
          "type": "text",
          "id": "price",
          "label": "Manual Price",
          "default": "0.00€",
          "info": "Price display when no product is selected (e.g., 0.00€ for free)"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button Label",
          "default": "Добави към кошницата"
        },
        {
          "type": "text",
          "id": "change_label",
          "label": "Change Link Label",
          "default": "Change"
        },
        {
          "type": "url",
          "id": "change_link",
          "label": "Change Link"
        }
      ]
    },
    {
      "type": "addon_category",
      "name": "Add-on Category",
      "settings": [
        {
          "type": "header",
          "content": "Филтриране и персонализация"
        },
        {
          "type": "select",
          "id": "filter_type",
          "label": "Тип филтриране",
          "options": [
            {
              "value": "any",
              "label": "ИЛИ (покажи ако е изпълнено кое и да е условие)"
            },
            {
              "value": "all",
              "label": "И (покажи ако са изпълнени всички условия)"
            }
          ],
          "default": "any",
          "info": "Изберете дали условията трябва да са изпълнени всички (И) или поне едно (ИЛИ)"
        },
        {
          "type": "product",
          "id": "target_product",
          "label": "Покажи за продукт",
          "info": "Изберете продукт, за който да се показва тази категория. Ако не е избран, ще се показва за всички продукти."
        },
        {
          "type": "collection",
          "id": "target_collection",
          "label": "Покажи за колекция",
          "info": "Изберете колекция - категорията ще се показва за всички продукти в тази колекция."
        },
        {
          "type": "text",
          "id": "required_tags",
          "label": "Задължителни тагове",
          "info": "Въведете тагове разделени със запетая (напр. premium,new,featured). Продуктът трябва да има ВСИЧКИ тагове."
        },
        {
          "type": "text",
          "id": "metafield_namespace",
          "label": "Метафилд Namespace",
          "default": "custom",
          "info": "Namespace на метафилда (напр. custom, global, product)"
        },
        {
          "type": "text",
          "id": "metafield_key",
          "label": "Метафилд Key",
          "info": "Key на метафилда за филтриране (напр. show_category, category_type)"
        },
        {
          "type": "text",
          "id": "metafield_value",
          "label": "Метафилд Стойност",
          "info": "Стойност на метафилда, която трябва да съвпада (оставете празно за проверка само за наличие)"
        },
        {
          "type": "header",
          "content": "Съдържание"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Category Title",
          "default": "Installation Accessories"
        },
        {
          "type": "checkbox",
          "id": "use_metafield_title",
          "label": "Използвай метафилд за заглавие",
          "default": false,
          "info": "Ако е активирано, заглавието ще се взима от метафилд на продукта"
        },
        {
          "type": "text",
          "id": "title_metafield_namespace",
          "label": "Title Метафилд Namespace",
          "default": "custom",
          "info": "Namespace за метафилда на заглавието"
        },
        {
          "type": "text",
          "id": "title_metafield_key",
          "label": "Title Метафилд Key",
          "info": "Key за метафилда на заглавието (напр. category_title)"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Етикет на бутон",
          "default": "Select"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Category Link"
        }
      ]
    },
    {
      "type": "product_category",
      "name": "Продуктова категория",
      "settings": [
        {
          "type": "product",
          "id": "target_product",
          "label": "Покажи за продукт",
          "info": "Изберете продукт, за който да се показва тази категория. Ако не е избран, ще се показва за всички продукти."
        },
        {
          "type": "text",
          "id": "title",
          "label": "Заглавие на категорията",
          "default": "Избрани продукти"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Колекция",
          "info": "Изберете колекция, от която да се показват продуктите (максимум 6)"
        },
        {
          "type": "number",
          "id": "max_products",
          "label": "Максимум продукти",
          "default": 6,
          "info": "Максимум 6 продукта"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Текст на бутона",
          "default": "Добави към кошницата"
        }
      ]
    },
    {
      "type": "payment_icon",
      "name": "Payment Icon",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Payment Icon",
          "info": "Upload payment method logo (e.g., Visa, Mastercard, etc.)"
        },
        {
          "type": "text",
          "id": "alt",
          "label": "Alt Text",
          "default": "Payment method"
        }
      ]
    },
    {
      "type": "metafield",
      "name": "Metafield",
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "info": "Display label for the metafield (e.g., 'Material', 'Warranty', etc.)",
          "default": "Metafield"
        },
        {
          "type": "text",
          "id": "namespace",
          "label": "Namespace",
          "info": "Metafield namespace (e.g., 'custom', 'global', 'product', etc.)",
          "default": "custom"
        },
        {
          "type": "text",
          "id": "key",
          "label": "Key",
          "info": "Metafield key (e.g., 'material', 'warranty_years', 'certification', etc.)"
        },
        {
          "type": "checkbox",
          "id": "show_empty",
          "label": "Покажи дори при празна стойност",
          "default": false,
          "info": "Показва метафилда дори ако няма стойност"
        },
        {
          "type": "text",
          "id": "empty_text",
          "label": "Текст при празна стойност",
          "default": "—",
          "info": "Текст който да се показва ако метафилдът е празен"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link Text",
          "info": "Optional text for URL metafields (if empty, the URL will be shown)"
        }
      ]
    }
  ],
  "max_blocks": 50,
  "presets": [
    {
      "name": "Избран Продукт",
      "blocks": [
        {
          "type": "badge"
        },
        {
          "type": "checklist_item"
        },
        {
          "type": "accordion"
        }
      ]
    }
  ]
}
{% endschema %}